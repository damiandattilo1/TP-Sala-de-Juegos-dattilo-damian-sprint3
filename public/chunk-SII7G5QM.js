import{A as Hi,Aa as mr,a as Ai,b as xi,c as Di,d as me,e as Nn,g as Oi,h as Rn,i as Mi,j as Li,k as Fi,ka as sr,l as Wi,la as ir,m as Ui,ma as rr,n as Bi,na as ye,o as Pn,oa as or,p as D,pa as lr,qa as ar,s as Vi,sa as cr,ta as hr,ua as ur,va as dr,w as Gi,wa as fr,xa as _r,ya as pr,za as gr}from"./chunk-IBXIO56K.js";import{A as $i,B as j,C as le,D as kt,E as Ye,G as Xi,H as Ji,I as g,J as U,K as P,L as An,M as Zi,N as ze,O as B,P as ke,Q as At,R as xn,S as er,T as xt,U as tr,V as nr,X as Dn,Y as Dt,a as Ri,b as Pi,d as ki,i as f,j as Pe,k as Qi,l as ji,m as Ki,n as M,o as qi,q as kn,r as Yi,s as J,x as Pt,y as R,z as zi}from"./chunk-K3XG54ZU.js";var yr="@firebase/database",vr="1.0.4";var js="";function Ks(n){js=n}var Vn=class{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),R(t))}get(e){let t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:Pt(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}};var Gn=class{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return j(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}};var $r=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){let e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new Vn(e)}}catch{}return new Gn},Ce=$r("localStorage"),Hn=$r("sessionStorage");var Oe=new xt("@firebase/database"),Xr=function(){let n=1;return function(){return n++}}(),Jr=function(n){let e=Zi(n),t=new Ji;t.update(e);let s=t.digest();return Qi.encodeByteArray(s)},vt=function(...n){let e="";for(let t=0;t<n.length;t++){let s=n[t];Array.isArray(s)||s&&typeof s=="object"&&typeof s.length=="number"?e+=vt.apply(null,s):typeof s=="object"?e+=R(s):e+=s,e+=" "}return e},we=null,Cr=!0,Zr=function(n,e){f(!e||n===!0||n===!1,"Can't turn on custom loggers persistently."),n===!0?(Oe.logLevel=er.VERBOSE,we=Oe.log.bind(Oe),e&&Hn.set("logging_enabled",!0)):typeof n=="function"?we=n:(we=null,Hn.remove("logging_enabled"))},A=function(...n){if(Cr===!0&&(Cr=!1,we===null&&Hn.get("logging_enabled")===!0&&Zr(!0)),we){let e=vt.apply(null,n);we(e)}},Ct=function(n){return function(...e){A(n,...e)}},Qn=function(...n){let e="FIREBASE INTERNAL ERROR: "+vt(...n);Oe.error(e)},te=function(...n){let e=`FIREBASE FATAL ERROR: ${vt(...n)}`;throw Oe.error(e),new Error(e)},O=function(...n){let e="FIREBASE WARNING: "+vt(...n);Oe.warn(e)},Gl=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&O("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},an=function(n){return typeof n=="number"&&(n!==n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},Hl=function(n){if(J()||document.readyState==="complete")n();else{let e=!1,t=function(){if(!document.body){setTimeout(t,Math.floor(10));return}e||(e=!0,n())};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&t()}),window.attachEvent("onload",t))}},ue="[MIN_NAME]",re="[MAX_NAME]",Te=function(n,e){if(n===e)return 0;if(n===ue||e===re)return-1;if(e===ue||n===re)return 1;{let t=wr(n),s=wr(e);return t!==null?s!==null?t-s===0?n.length-e.length:t-s:-1:s!==null?1:n<e?-1:1}},Ql=function(n,e){return n===e?0:n<e?-1:1},$e=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+R(e))},qs=function(n){if(typeof n!="object"||n===null)return R(n);let e=[];for(let s in n)e.push(s);e.sort();let t="{";for(let s=0;s<e.length;s++)s!==0&&(t+=","),t+=R(e[s]),t+=":",t+=qs(n[e[s]]);return t+="}",t},eo=function(n,e){let t=n.length;if(t<=e)return[n];let s=[];for(let i=0;i<t;i+=e)i+e>t?s.push(n.substring(i,t)):s.push(n.substring(i,i+e));return s};function x(n,e){for(let t in n)n.hasOwnProperty(t)&&e(t,n[t])}var to=function(n){f(!an(n),"Invalid JSON number");let e=11,t=52,s=(1<<e-1)-1,i,r,o,l,a;n===0?(r=0,o=0,i=1/n===-1/0?1:0):(i=n<0,n=Math.abs(n),n>=Math.pow(2,1-s)?(l=Math.min(Math.floor(Math.log(n)/Math.LN2),s),r=l+s,o=Math.round(n*Math.pow(2,t-l)-Math.pow(2,t))):(r=0,o=Math.round(n/Math.pow(2,1-s-t))));let c=[];for(a=t;a;a-=1)c.push(o%2?1:0),o=Math.floor(o/2);for(a=e;a;a-=1)c.push(r%2?1:0),r=Math.floor(r/2);c.push(i?1:0),c.reverse();let h=c.join(""),u="";for(a=0;a<64;a+=8){let d=parseInt(h.substr(a,8),2).toString(16);d.length===1&&(d="0"+d),u=u+d}return u.toLowerCase()},jl=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},Kl=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function ql(n,e){let t="Unknown Error";n==="too_big"?t="The data requested exceeds the maximum size that can be accessed with a single request.":n==="permission_denied"?t="Client doesn't have permission to access the desired data.":n==="unavailable"&&(t="The service is unavailable");let s=new Error(n+" at "+e._path.toString()+": "+t);return s.code=n.toUpperCase(),s}var Yl=new RegExp("^-?(0*)\\d{1,10}$"),zl=-2147483648,$l=2147483647,wr=function(n){if(Yl.test(n)){let e=Number(n);if(e>=zl&&e<=$l)return e}return null},He=function(n){try{n()}catch(e){setTimeout(()=>{let t=e.stack||"";throw O("Exception was thrown by user callback.",t),e},Math.floor(0))}},Xl=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},et=function(n,e){let t=setTimeout(n,e);return typeof t=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):typeof t=="object"&&t.unref&&t.unref(),t};var jn=class{constructor(e,t){this.appName_=e,this.appCheckProvider=t,this.appCheck=t?.getImmediate({optional:!0}),this.appCheck||t?.get().then(s=>this.appCheck=s)}getToken(e){return this.appCheck?this.appCheck.getToken(e):new Promise((t,s)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){var t;(t=this.appCheckProvider)===null||t===void 0||t.get().then(s=>s.addTokenListener(e))}notifyForInvalidToken(){O(`Provided AppCheck credentials for the app named "${this.appName_}" are invalid. This usually indicates your app was not initialized correctly.`)}};var Kn=class{constructor(e,t,s){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=s,this.auth_=null,this.auth_=s.getImmediate({optional:!0}),this.auth_||s.onInit(i=>this.auth_=i)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&t.code==="auth/token-not-initialized"?(A("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,s)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',O(e)}},tt=(()=>{class n{constructor(t){this.accessToken=t}getToken(t){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(t){t(this.accessToken)}removeTokenChangeListener(t){}notifyForInvalidToken(){}}n.OWNER="owner";return n})(),Mt="5",no="v",so="s",io="r",ro="f",oo=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,lo="ls",ao="p",qn="ac",co="websocket",ho="long_polling";var Lt=class{constructor(e,t,s,i,r=!1,o="",l=!1,a=!1){this.secure=t,this.namespace=s,this.webSocketOnly=i,this.nodeAdmin=r,this.persistenceKey=o,this.includeNamespaceInQueryParams=l,this.isUsingEmulator=a,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=Ce.get("host:"+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&Ce.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){let e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}};function Jl(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams}function uo(n,e,t){f(typeof e=="string","typeof type must == string"),f(typeof t=="object","typeof params must == object");let s;if(e===co)s=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else if(e===ho)s=(n.secure?"https://":"http://")+n.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+e);Jl(n)&&(t.ns=n.namespace);let i=[];return x(t,(r,o)=>{i.push(r+"="+o)}),s+i.join("&")}var Yn=class{constructor(){this.counters_={}}incrementCounter(e,t=1){j(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return Ki(this.counters_)}};var On={},Mn={};function Ys(n){let e=n.toString();return On[e]||(On[e]=new Yn),On[e]}function Zl(n,e){let t=n.toString();return Mn[t]||(Mn[t]=e()),Mn[t]}var zn=class{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){let s=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let i=0;i<s.length;++i)s[i]&&He(()=>{this.onMessage_(s[i])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}};var Er="start",ea="close",ta="pLPCommand",na="pRTLPCB",fo="id",_o="pw",po="ser",sa="cb",ia="seg",ra="ts",oa="d",la="dframe",go=1870,mo=30,aa=go-mo,ca=25e3,ha=3e4,rt=class n{constructor(e,t,s,i,r,o,l){this.connId=e,this.repoInfo=t,this.applicationId=s,this.appCheckToken=i,this.authToken=r,this.transportSessionId=o,this.lastSessionId=l,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=Ct(e),this.stats_=Ys(t),this.urlFn=a=>(this.appCheckToken&&(a[qn]=this.appCheckToken),uo(t,ho,a))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new zn(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(ha)),Hl(()=>{if(this.isClosed_)return;this.scriptTagHolder=new $n((...r)=>{let[o,l,a,c,h]=r;if(this.incrementIncomingBytes_(r),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,o===Er)this.id=l,this.password=a;else if(o===ea)l?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(l,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+o)},(...r)=>{let[o,l]=r;this.incrementIncomingBytes_(r),this.myPacketOrderer.handleResponse(o,l)},()=>{this.onClosed_()},this.urlFn);let s={};s[Er]="t",s[po]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(s[sa]=this.scriptTagHolder.uniqueCallbackIdentifier),s[no]=Mt,this.transportSessionId&&(s[so]=this.transportSessionId),this.lastSessionId&&(s[lo]=this.lastSessionId),this.applicationId&&(s[ao]=this.applicationId),this.appCheckToken&&(s[qn]=this.appCheckToken),typeof location<"u"&&location.hostname&&oo.test(location.hostname)&&(s[io]=ro);let i=this.urlFn(s);this.log_("Connecting via long-poll to "+i),this.scriptTagHolder.addTag(i,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){n.forceAllow_=!0}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){return J()?!1:n.forceAllow_?!0:!n.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!jl()&&!Kl()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){let t=R(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);let s=ji(t),i=eo(s,aa);for(let r=0;r<i.length;r++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,i.length,i[r]),this.curSegmentNum++}addDisconnectPingFrame(e,t){if(J())return;this.myDisconnFrame=document.createElement("iframe");let s={};s[la]="t",s[fo]=e,s[_o]=t,this.myDisconnFrame.src=this.urlFn(s),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){let t=R(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}},$n=class n{constructor(e,t,s,i){if(this.onDisconnect=s,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0,J())this.commandCB=e,this.onMessageCB=t;else{this.uniqueCallbackIdentifier=Xr(),window[ta+this.uniqueCallbackIdentifier]=e,window[na+this.uniqueCallbackIdentifier]=t,this.myIFrame=n.createIFrame_();let r="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(r='<script>document.domain="'+document.domain+'";<\/script>');let o="<html><body>"+r+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(l){A("frame writing exception"),l.stack&&A(l.stack),A(l)}}}static createIFrame_(){let e=document.createElement("iframe");if(e.style.display="none",document.body){document.body.appendChild(e);try{e.contentWindow.document||A("No IE domain setting required")}catch{let s=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+s+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));let e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;let e={};e[fo]=this.myID,e[_o]=this.myPW,e[po]=this.currentSerial;let t=this.urlFn(e),s="",i=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+mo+s.length<=go;){let o=this.pendingSegs.shift();s=s+"&"+ia+i+"="+o.seg+"&"+ra+i+"="+o.ts+"&"+oa+i+"="+o.d,i++}return t=t+s,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,s){this.pendingSegs.push({seg:e,ts:t,d:s}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);let s=()=>{this.outstandingRequests.delete(t),this.newRequest_()},i=setTimeout(s,Math.floor(ca)),r=()=>{clearTimeout(i),s()};this.addTag(e,r)}addTag(e,t){J()?this.doNodeLongPoll(e,t):setTimeout(()=>{try{if(!this.sendNewPolls)return;let s=this.myIFrame.doc.createElement("script");s.type="text/javascript",s.async=!0,s.src=e,s.onload=s.onreadystatechange=function(){let i=s.readyState;(!i||i==="loaded"||i==="complete")&&(s.onload=s.onreadystatechange=null,s.parentNode&&s.parentNode.removeChild(s),t())},s.onerror=()=>{A("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(s)}catch{}},Math.floor(1))}};var ua=16384,da=45e3,Ft=null;typeof MozWebSocket<"u"?Ft=MozWebSocket:typeof WebSocket<"u"&&(Ft=WebSocket);var xe=(()=>{class n{constructor(t,s,i,r,o,l,a){this.connId=t,this.applicationId=i,this.appCheckToken=r,this.authToken=o,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=Ct(this.connId),this.stats_=Ys(s),this.connURL=n.connectionURL_(s,l,a,r,i),this.nodeAdmin=s.nodeAdmin}static connectionURL_(t,s,i,r,o){let l={};return l[no]=Mt,!J()&&typeof location<"u"&&location.hostname&&oo.test(location.hostname)&&(l[io]=ro),s&&(l[so]=s),i&&(l[lo]=i),r&&(l[qn]=r),o&&(l[ao]=o),uo(t,co,l)}open(t,s){this.onDisconnect=s,this.onMessage=t,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,Ce.set("previous_websocket_failure",!0);try{let i;if(J()){let r=this.nodeAdmin?"AdminNode":"Node";i={headers:{"User-Agent":`Firebase/${Mt}/${js}/${process.platform}/${r}`,"X-Firebase-GMPID":this.applicationId||""}},this.authToken&&(i.headers.Authorization=`Bearer ${this.authToken}`),this.appCheckToken&&(i.headers["X-Firebase-AppCheck"]=this.appCheckToken);let o=process.env,l=this.connURL.indexOf("wss://")===0?o.HTTPS_PROXY||o.https_proxy:o.HTTP_PROXY||o.http_proxy;l&&(i.proxy={origin:l})}this.mySock=new Ft(this.connURL,[],i)}catch(i){this.log_("Error instantiating WebSocket.");let r=i.message||i.data;r&&this.log_(r),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=i=>{this.handleIncomingFrame(i)},this.mySock.onerror=i=>{this.log_("WebSocket error.  Closing connection.");let r=i.message||i.data;r&&this.log_(r),this.onClosed_()}}start(){}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){let t=!1;if(typeof navigator<"u"&&navigator.userAgent){let s=/Android ([0-9]{0,}\.[0-9]{0,})/,i=navigator.userAgent.match(s);i&&i.length>1&&parseFloat(i[1])<4.4&&(t=!0)}return!t&&Ft!==null&&!n.forceDisallow_}static previouslyFailed(){return Ce.isInMemoryStorage||Ce.get("previous_websocket_failure")===!0}markConnectionHealthy(){Ce.remove("previous_websocket_failure")}appendFrame_(t){if(this.frames.push(t),this.frames.length===this.totalFrames){let s=this.frames.join("");this.frames=null;let i=Pt(s);this.onMessage(i)}}handleNewFrameCount_(t){this.totalFrames=t,this.frames=[]}extractFrameCount_(t){if(f(this.frames===null,"We already have a frame buffer"),t.length<=6){let s=Number(t);if(!isNaN(s))return this.handleNewFrameCount_(s),null}return this.handleNewFrameCount_(1),t}handleIncomingFrame(t){if(this.mySock===null)return;let s=t.data;if(this.bytesReceived+=s.length,this.stats_.incrementCounter("bytes_received",s.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(s);else{let i=this.extractFrameCount_(s);i!==null&&this.appendFrame_(i)}}send(t){this.resetKeepAlive();let s=R(t);this.bytesSent+=s.length,this.stats_.incrementCounter("bytes_sent",s.length);let i=eo(s,ua);i.length>1&&this.sendString_(String(i.length));for(let r=0;r<i.length;r++)this.sendString_(i[r])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(da))}sendString_(t){try{this.mySock.send(t)}catch(s){this.log_("Exception thrown from WebSocket.send():",s.message||s.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}n.responsesRequiredToBeHealthy=2,n.healthyTimeout=3e4;return n})(),yo=(()=>{class n{constructor(t){this.initTransports_(t)}static get ALL_TRANSPORTS(){return[rt,xe]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}initTransports_(t){let s=xe&&xe.isAvailable(),i=s&&!xe.previouslyFailed();if(t.webSocketOnly&&(s||O("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),i=!0),i)this.transports_=[xe];else{let r=this.transports_=[];for(let o of n.ALL_TRANSPORTS)o&&o.isAvailable()&&r.push(o);n.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}n.globalTransportInitialized_=!1;return n})(),fa=6e4,_a=5e3,pa=10*1024,ga=100*1024,Ln="t",Tr="d",ma="s",Ir="r",ya="e",Sr="o",br="a",Nr="n",Rr="p",va="h",Xn=class{constructor(e,t,s,i,r,o,l,a,c,h){this.id=e,this.repoInfo_=t,this.applicationId_=s,this.appCheckToken_=i,this.authToken_=r,this.onMessage_=o,this.onReady_=l,this.onDisconnect_=a,this.onKill_=c,this.lastSessionId=h,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=Ct("c:"+this.id+":"),this.transportManager_=new yo(t),this.log_("Connection created"),this.start_()}start_(){let e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.conn_),s=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,s)},Math.floor(0));let i=e.healthyTimeout||0;i>0&&(this.healthyTimeout_=et(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>ga?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>pa?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(i)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){let t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(Ln in e){let t=e[Ln];t===br?this.upgradeIfSecondaryHealthy_():t===Ir?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===Sr&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){let t=$e("t",e),s=$e("d",e);if(t==="c")this.onSecondaryControl_(s);else if(t==="d")this.pendingDataMessages.push(s);else throw new Error("Unknown protocol layer: "+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:Rr,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:br,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:Nr,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){let t=$e("t",e),s=$e("d",e);t==="c"?this.onControl_(s):t==="d"&&this.onDataMessage_(s)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){let t=$e(Ln,e);if(Tr in e){let s=e[Tr];if(t===va){let i=Object.assign({},s);this.repoInfo_.isUsingEmulator&&(i.h=this.repoInfo_.host),this.onHandshake_(i)}else if(t===Nr){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===ma?this.onConnectionShutdown_(s):t===Ir?this.onReset_(s):t===ya?Qn("Server Error: "+s):t===Sr?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):Qn("Unknown control packet command: "+t)}}onHandshake_(e){let t=e.ts,s=e.v,i=e.h;this.sessionId=e.s,this.repoInfo_.host=i,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),Mt!==s&&O("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){let e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.secondaryConn_),s=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,s),et(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(fa))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):et(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(_a))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:Rr,d:{}}}))}onSecondaryConnectionLost_(){let e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(Ce.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(e)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}};var Wt=class{put(e,t,s,i){}merge(e,t,s,i){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,s){}onDisconnectMerge(e,t,s){}onDisconnectCancel(e,t){}reportStats(e){}};var Ut=class{constructor(e){this.allowedEvents_=e,this.listeners_={},f(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){let s=[...this.listeners_[e]];for(let i=0;i<s.length;i++)s[i].callback.apply(s[i].context,t)}}on(e,t,s){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:s});let i=this.getInitialEvent(e);i&&t.apply(s,i)}off(e,t,s){this.validateEventType_(e);let i=this.listeners_[e]||[];for(let r=0;r<i.length;r++)if(i[r].callback===t&&(!s||s===i[r].context)){i.splice(r,1);return}}validateEventType_(e){f(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}};var Bt=class n extends Ut{constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!kn()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}static getInstance(){return new n}getInitialEvent(e){return f(e==="online","Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}};var Pr=32,kr=768,E=class{constructor(e,t){if(t===void 0){this.pieces_=e.split("/");let s=0;for(let i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[s]=this.pieces_[i],s++);this.pieces_.length=s,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==""&&(e+="/"+this.pieces_[t]);return e||"/"}};function w(){return new E("")}function y(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function de(n){return n.pieces_.length-n.pieceNum_}function I(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new E(n.pieces_,e)}function zs(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function Ca(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)n.pieces_[t]!==""&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}function ot(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function vo(n){if(n.pieceNum_>=n.pieces_.length)return null;let e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new E(e,0)}function b(n,e){let t=[];for(let s=n.pieceNum_;s<n.pieces_.length;s++)t.push(n.pieces_[s]);if(e instanceof E)for(let s=e.pieceNum_;s<e.pieces_.length;s++)t.push(e.pieces_[s]);else{let s=e.split("/");for(let i=0;i<s.length;i++)s[i].length>0&&t.push(s[i])}return new E(t,0)}function v(n){return n.pieceNum_>=n.pieces_.length}function L(n,e){let t=y(n),s=y(e);if(t===null)return e;if(t===s)return L(I(n),I(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function wa(n,e){let t=ot(n,0),s=ot(e,0);for(let i=0;i<t.length&&i<s.length;i++){let r=Te(t[i],s[i]);if(r!==0)return r}return t.length===s.length?0:t.length<s.length?-1:1}function $s(n,e){if(de(n)!==de(e))return!1;for(let t=n.pieceNum_,s=e.pieceNum_;t<=n.pieces_.length;t++,s++)if(n.pieces_[t]!==e.pieces_[s])return!1;return!0}function K(n,e){let t=n.pieceNum_,s=e.pieceNum_;if(de(n)>de(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[s])return!1;++t,++s}return!0}var Jn=class{constructor(e,t){this.errorPrefix_=t,this.parts_=ot(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let s=0;s<this.parts_.length;s++)this.byteLength_+=ze(this.parts_[s]);Co(this)}};function Ea(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=ze(e),Co(n)}function Ta(n){let e=n.parts_.pop();n.byteLength_-=ze(e),n.parts_.length>0&&(n.byteLength_-=1)}function Co(n){if(n.byteLength_>kr)throw new Error(n.errorPrefix_+"has a key path longer than "+kr+" bytes ("+n.byteLength_+").");if(n.parts_.length>Pr)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+Pr+") or object contains a cycle "+ve(n))}function ve(n){return n.parts_.length===0?"":"in property '"+n.parts_.join(".")+"'"}var Zn=class n extends Ut{constructor(){super(["visible"]);let e,t;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{let s=!document[e];s!==this.visible_&&(this.visible_=s,this.trigger("visible",s))},!1)}static getInstance(){return new n}getInitialEvent(e){return f(e==="visible","Unknown event type: "+e),[this.visible_]}};var Xe=1e3,Ia=60*5*1e3,Ar=30*1e3,Sa=1.3,ba=3e4,Na="server_kill",xr=3,Xs=(()=>{class n extends Wt{constructor(t,s,i,r,o,l,a,c){if(super(),this.repoInfo_=t,this.applicationId_=s,this.onDataUpdate_=i,this.onConnectStatus_=r,this.onServerInfoUpdate_=o,this.authTokenProvider_=l,this.appCheckTokenProvider_=a,this.authOverride_=c,this.id=n.nextPersistentConnectionId_++,this.log_=Ct("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=Xe,this.maxReconnectDelay_=Ia,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,c&&!J())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");Zn.getInstance().on("visible",this.onVisible_,this),t.host.indexOf("fblocal")===-1&&Bt.getInstance().on("online",this.onOnline_,this)}sendRequest(t,s,i){let r=++this.requestNumber_,o={r,a:t,b:s};this.log_(R(o)),f(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(o),i&&(this.requestCBHash_[r]=i)}get(t){this.initConnection_();let s=new M,r={action:"g",request:{p:t._path.toString(),q:t._queryObject},onComplete:l=>{let a=l.d;l.s==="ok"?s.resolve(a):s.reject(a)}};this.outstandingGets_.push(r),this.outstandingGetCount_++;let o=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(o),s.promise}listen(t,s,i,r){this.initConnection_();let o=t._queryIdentifier,l=t._path.toString();this.log_("Listen called for "+l+" "+o),this.listens.has(l)||this.listens.set(l,new Map),f(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"listen() called for non-default but complete query"),f(!this.listens.get(l).has(o),"listen() called twice for same path/queryId.");let a={onComplete:r,hashFn:s,query:t,tag:i};this.listens.get(l).set(o,a),this.connected_&&this.sendListen_(a)}sendGet_(t){let s=this.outstandingGets_[t];this.sendRequest("g",s.request,i=>{delete this.outstandingGets_[t],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),s.onComplete&&s.onComplete(i)})}sendListen_(t){let s=t.query,i=s._path.toString(),r=s._queryIdentifier;this.log_("Listen on "+i+" for "+r);let o={p:i},l="q";t.tag&&(o.q=s._queryObject,o.t=t.tag),o.h=t.hashFn(),this.sendRequest(l,o,a=>{let c=a.d,h=a.s;n.warnOnListenWarnings_(c,s),(this.listens.get(i)&&this.listens.get(i).get(r))===t&&(this.log_("listen response",a),h!=="ok"&&this.removeListen_(i,r),t.onComplete&&t.onComplete(h,c))})}static warnOnListenWarnings_(t,s){if(t&&typeof t=="object"&&j(t,"w")){let i=le(t,"w");if(Array.isArray(i)&&~i.indexOf("no_index")){let r='".indexOn": "'+s._queryParams.getIndex().toString()+'"',o=s._path.toString();O(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${r} at ${o} to your security rules for better performance.`)}}}refreshAuthToken(t){this.authToken_=t,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(t)}reduceReconnectDelayIfAdminCredential_(t){(t&&t.length===40||$i(t))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=Ar)}refreshAppCheckToken(t){this.appCheckToken_=t,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){let t=this.authToken_,s=zi(t)?"auth":"gauth",i={cred:t};this.authOverride_===null?i.noauth=!0:typeof this.authOverride_=="object"&&(i.authvar=this.authOverride_),this.sendRequest(s,i,r=>{let o=r.s,l=r.d||"error";this.authToken_===t&&(o==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(o,l))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},t=>{let s=t.s,i=t.d||"error";s==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(s,i)})}unlisten(t,s){let i=t._path.toString(),r=t._queryIdentifier;this.log_("Unlisten called for "+i+" "+r),f(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(i,r)&&this.connected_&&this.sendUnlisten_(i,r,t._queryObject,s)}sendUnlisten_(t,s,i,r){this.log_("Unlisten on "+t+" for "+s);let o={p:t},l="n";r&&(o.q=i,o.t=r),this.sendRequest(l,o)}onDisconnectPut(t,s,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",t,s,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"o",data:s,onComplete:i})}onDisconnectMerge(t,s,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",t,s,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"om",data:s,onComplete:i})}onDisconnectCancel(t,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",t,null,s):this.onDisconnectRequestQueue_.push({pathString:t,action:"oc",data:null,onComplete:s})}sendOnDisconnect_(t,s,i,r){let o={p:s,d:i};this.log_("onDisconnect "+t,o),this.sendRequest(t,o,l=>{r&&setTimeout(()=>{r(l.s,l.d)},Math.floor(0))})}put(t,s,i,r){this.putInternal("p",t,s,i,r)}merge(t,s,i,r){this.putInternal("m",t,s,i,r)}putInternal(t,s,i,r,o){this.initConnection_();let l={p:s,d:i};o!==void 0&&(l.h=o),this.outstandingPuts_.push({action:t,request:l,onComplete:r}),this.outstandingPutCount_++;let a=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(a):this.log_("Buffering put: "+s)}sendPut_(t){let s=this.outstandingPuts_[t].action,i=this.outstandingPuts_[t].request,r=this.outstandingPuts_[t].onComplete;this.outstandingPuts_[t].queued=this.connected_,this.sendRequest(s,i,o=>{this.log_(s+" response",o),delete this.outstandingPuts_[t],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),r&&r(o.s,o.d)})}reportStats(t){if(this.connected_){let s={c:t};this.log_("reportStats",s),this.sendRequest("s",s,i=>{if(i.s!=="ok"){let o=i.d;this.log_("reportStats","Error sending stats: "+o)}})}}onDataMessage_(t){if("r"in t){this.log_("from server: "+R(t));let s=t.r,i=this.requestCBHash_[s];i&&(delete this.requestCBHash_[s],i(t.b))}else{if("error"in t)throw"A server-side error has occurred: "+t.error;"a"in t&&this.onDataPush_(t.a,t.b)}}onDataPush_(t,s){this.log_("handleServerMessage",t,s),t==="d"?this.onDataUpdate_(s.p,s.d,!1,s.t):t==="m"?this.onDataUpdate_(s.p,s.d,!0,s.t):t==="c"?this.onListenRevoked_(s.p,s.q):t==="ac"?this.onAuthRevoked_(s.s,s.d):t==="apc"?this.onAppCheckRevoked_(s.s,s.d):t==="sd"?this.onSecurityDebugPacket_(s):Qn("Unrecognized action received from server: "+R(t)+`
Are you using the latest client?`)}onReady_(t,s){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(t),this.lastSessionId=s,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(t){f(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(t))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(t){t&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=Xe,this.realtime_||this.scheduleConnect_(0)),this.visible_=t}onOnline_(t){t?(this.log_("Browser went online."),this.reconnectDelay_=Xe,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>ba&&(this.reconnectDelay_=Xe),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());let t=new Date().getTime()-this.lastConnectionAttemptTime_,s=Math.max(0,this.reconnectDelay_-t);s=Math.random()*s,this.log_("Trying to reconnect in "+s+"ms"),this.scheduleConnect_(s),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*Sa)}this.onConnectStatus_(!1)}establishConnection_(){return ki(this,null,function*(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;let t=this.onDataMessage_.bind(this),s=this.onReady_.bind(this),i=this.onRealtimeDisconnect_.bind(this),r=this.id+":"+n.nextConnectionId_++,o=this.lastSessionId,l=!1,a=null,c=function(){a?a.close():(l=!0,i())},h=function(d){f(a,"sendRequest call when we're not connected not allowed."),a.sendRequest(d)};this.realtime_={close:c,sendRequest:h};let u=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{let[d,_]=yield Promise.all([this.authTokenProvider_.getToken(u),this.appCheckTokenProvider_.getToken(u)]);l?A("getToken() completed but was canceled"):(A("getToken() completed. Creating connection."),this.authToken_=d&&d.accessToken,this.appCheckToken_=_&&_.token,a=new Xn(r,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,t,s,i,p=>{O(p+" ("+this.repoInfo_.toString()+")"),this.interrupt(Na)},o))}catch(d){this.log_("Failed to get token: "+d),l||(this.repoInfo_.nodeAdmin&&O(d),c())}}})}interrupt(t){A("Interrupting connection for reason: "+t),this.interruptReasons_[t]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(t){A("Resuming connection for reason: "+t),delete this.interruptReasons_[t],kt(this.interruptReasons_)&&(this.reconnectDelay_=Xe,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(t){let s=t-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:s})}cancelSentTransactions_(){for(let t=0;t<this.outstandingPuts_.length;t++){let s=this.outstandingPuts_[t];s&&"h"in s.request&&s.queued&&(s.onComplete&&s.onComplete("disconnect"),delete this.outstandingPuts_[t],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(t,s){let i;s?i=s.map(o=>qs(o)).join("$"):i="default";let r=this.removeListen_(t,i);r&&r.onComplete&&r.onComplete("permission_denied")}removeListen_(t,s){let i=new E(t).toString(),r;if(this.listens.has(i)){let o=this.listens.get(i);r=o.get(s),o.delete(s),o.size===0&&this.listens.delete(i)}else r=void 0;return r}onAuthRevoked_(t,s){A("Auth token revoked: "+t+"/"+s),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(t==="invalid_token"||t==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=xr&&(this.reconnectDelay_=Ar,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(t,s){A("App check token revoked: "+t+"/"+s),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(t==="invalid_token"||t==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=xr&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(t){this.securityDebugCallback_?this.securityDebugCallback_(t):"msg"in t&&console.log("FIREBASE: "+t.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(let t of this.listens.values())for(let s of t.values())this.sendListen_(s);for(let t=0;t<this.outstandingPuts_.length;t++)this.outstandingPuts_[t]&&this.sendPut_(t);for(;this.onDisconnectRequestQueue_.length;){let t=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(t.action,t.pathString,t.data,t.onComplete)}for(let t=0;t<this.outstandingGets_.length;t++)this.outstandingGets_[t]&&this.sendGet_(t)}sendConnectStats_(){let t={},s="js";J()&&(this.repoInfo_.nodeAdmin?s="admin_node":s="node"),t["sdk."+s+"."+js.replace(/\./g,"-")]=1,kn()?t["framework.cordova"]=1:Yi()&&(t["framework.reactnative"]=1),this.reportStats(t)}shouldReconnect_(){let t=Bt.getInstance().currentlyOnline();return kt(this.interruptReasons_)&&t}}n.nextPersistentConnectionId_=0,n.nextConnectionId_=0;return n})(),C=class n{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new n(e,t)}};var Me=class{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){let s=new C(ue,e),i=new C(ue,t);return this.compare(s,i)!==0}minPost(){return C.MIN}};var Ot,Vt=class extends Me{static get __EMPTY_NODE(){return Ot}static set __EMPTY_NODE(e){Ot=e}compare(e,t){return Te(e.name,t.name)}isDefinedOn(e){throw Pe("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return C.MIN}maxPost(){return new C(re,Ot)}makePost(e,t){return f(typeof e=="string","KeyIndex indexValue must always be a string."),new C(e,Ot)}toString(){return".key"}},ee=new Vt;var De=class{constructor(e,t,s,i,r=null){this.isReverse_=i,this.resultGenerator_=r,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(e=e,o=t?s(e.key,t):1,i&&(o*=-1),o<0)this.isReverse_?e=e.left:e=e.right;else if(o===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),this.isReverse_?e=e.right:e=e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(this.resultGenerator_?t=this.resultGenerator_(e.key,e.value):t={key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}},z=(()=>{class n{constructor(t,s,i,r,o){this.key=t,this.value=s,this.color=i??n.RED,this.left=r??q.EMPTY_NODE,this.right=o??q.EMPTY_NODE}copy(t,s,i,r,o){return new n(t??this.key,s??this.value,i??this.color,r??this.left,o??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||!!t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,s,i){let r=this,o=i(t,r.key);return o<0?r=r.copy(null,null,null,r.left.insert(t,s,i),null):o===0?r=r.copy(null,s,null,null,null):r=r.copy(null,null,null,null,r.right.insert(t,s,i)),r.fixUp_()}removeMin_(){if(this.left.isEmpty())return q.EMPTY_NODE;let t=this;return!t.left.isRed_()&&!t.left.left.isRed_()&&(t=t.moveRedLeft_()),t=t.copy(null,null,null,t.left.removeMin_(),null),t.fixUp_()}remove(t,s){let i,r;if(i=this,s(t,i.key)<0)!i.left.isEmpty()&&!i.left.isRed_()&&!i.left.left.isRed_()&&(i=i.moveRedLeft_()),i=i.copy(null,null,null,i.left.remove(t,s),null);else{if(i.left.isRed_()&&(i=i.rotateRight_()),!i.right.isEmpty()&&!i.right.isRed_()&&!i.right.left.isRed_()&&(i=i.moveRedRight_()),s(t,i.key)===0){if(i.right.isEmpty())return q.EMPTY_NODE;r=i.right.min_(),i=i.copy(r.key,r.value,null,null,i.right.removeMin_())}i=i.copy(null,null,null,null,i.right.remove(t,s))}return i.fixUp_()}isRed_(){return this.color}fixUp_(){let t=this;return t.right.isRed_()&&!t.left.isRed_()&&(t=t.rotateLeft_()),t.left.isRed_()&&t.left.left.isRed_()&&(t=t.rotateRight_()),t.left.isRed_()&&t.right.isRed_()&&(t=t.colorFlip_()),t}moveRedLeft_(){let t=this.colorFlip_();return t.right.left.isRed_()&&(t=t.copy(null,null,null,null,t.right.rotateRight_()),t=t.rotateLeft_(),t=t.colorFlip_()),t}moveRedRight_(){let t=this.colorFlip_();return t.left.left.isRed_()&&(t=t.rotateRight_(),t=t.colorFlip_()),t}rotateLeft_(){let t=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight_(){let t=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip_(){let t=this.left.copy(null,null,!this.left.color,null,null),s=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,s)}checkMaxDepth_(){let t=this.check_();return Math.pow(2,t)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");let t=this.left.check_();if(t!==this.right.check_())throw new Error("Black depths differ");return t+(this.isRed_()?0:1)}}return n.RED=!0,n.BLACK=!1,n})(),es=class{copy(e,t,s,i,r){return this}insert(e,t,s){return new z(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}},q=class n{constructor(e,t=n.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new n(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,z.BLACK,null,null))}remove(e){return new n(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,z.BLACK,null,null))}get(e){let t,s=this.root_;for(;!s.isEmpty();){if(t=this.comparator_(e,s.key),t===0)return s.value;t<0?s=s.left:t>0&&(s=s.right)}return null}getPredecessorKey(e){let t,s=this.root_,i=null;for(;!s.isEmpty();)if(t=this.comparator_(e,s.key),t===0){if(s.left.isEmpty())return i?i.key:null;for(s=s.left;!s.right.isEmpty();)s=s.right;return s.key}else t<0?s=s.left:t>0&&(i=s,s=s.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new De(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new De(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new De(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new De(this.root_,null,this.comparator_,!0,e)}};q.EMPTY_NODE=new es;function Ra(n,e){return Te(n.name,e.name)}function Js(n,e){return Te(n,e)}var ts;function Pa(n){ts=n}var wo=function(n){return typeof n=="number"?"number:"+to(n):"string:"+n},Eo=function(n){if(n.isLeafNode()){let e=n.val();f(typeof e=="string"||typeof e=="number"||typeof e=="object"&&j(e,".sv"),"Priority must be a string or number.")}else f(n===ts||n.isEmpty(),"priority of unexpected type.");f(n===ts||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};var Dr,Le=(()=>{class n{constructor(t,s=n.__childrenNodeConstructor.EMPTY_NODE){this.value_=t,this.priorityNode_=s,this.lazyHash_=null,f(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),Eo(this.priorityNode_)}static set __childrenNodeConstructor(t){Dr=t}static get __childrenNodeConstructor(){return Dr}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(t){return new n(this.value_,t)}getImmediateChild(t){return t===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}getChild(t){return v(t)?this:y(t)===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(t,s){return null}updateImmediateChild(t,s){return t===".priority"?this.updatePriority(s):s.isEmpty()&&t!==".priority"?this:n.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,s).updatePriority(this.priorityNode_)}updateChild(t,s){let i=y(t);return i===null?s:s.isEmpty()&&i!==".priority"?this:(f(i!==".priority"||de(t)===1,".priority must be the last token in a path"),this.updateImmediateChild(i,n.__childrenNodeConstructor.EMPTY_NODE.updateChild(I(t),s)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(t,s){return!1}val(t){return t&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let t="";this.priorityNode_.isEmpty()||(t+="priority:"+wo(this.priorityNode_.val())+":");let s=typeof this.value_;t+=s+":",s==="number"?t+=to(this.value_):t+=this.value_,this.lazyHash_=Jr(t)}return this.lazyHash_}getValue(){return this.value_}compareTo(t){return t===n.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof n.__childrenNodeConstructor?-1:(f(t.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(t))}compareToLeafNode_(t){let s=typeof t.value_,i=typeof this.value_,r=n.VALUE_TYPE_ORDER.indexOf(s),o=n.VALUE_TYPE_ORDER.indexOf(i);return f(r>=0,"Unknown leaf type: "+s),f(o>=0,"Unknown leaf type: "+i),r===o?i==="object"?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:o-r}withIndex(){return this}isIndexed(){return!0}equals(t){if(t===this)return!0;if(t.isLeafNode()){let s=t;return this.value_===s.value_&&this.priorityNode_.equals(s.priorityNode_)}else return!1}}n.VALUE_TYPE_ORDER=["object","boolean","number","string"];return n})(),To,Io;function ka(n){To=n}function Aa(n){Io=n}var ns=class extends Me{compare(e,t){let s=e.node.getPriority(),i=t.node.getPriority(),r=s.compareTo(i);return r===0?Te(e.name,t.name):r}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return C.MIN}maxPost(){return new C(re,new Le("[PRIORITY-POST]",Io))}makePost(e,t){let s=To(e);return new C(t,new Le("[PRIORITY-POST]",s))}toString(){return".priority"}},S=new ns;var xa=Math.log(2),ss=class{constructor(e){let t=r=>parseInt(Math.log(r)/xa,10),s=r=>parseInt(Array(r+1).join("1"),2);this.count=t(e+1),this.current_=this.count-1;let i=s(this.count);this.bits_=e+1&i}nextBitIsOne(){let e=!(this.bits_&1<<this.current_);return this.current_--,e}},Gt=function(n,e,t,s){n.sort(e);let i=function(a,c){let h=c-a,u,d;if(h===0)return null;if(h===1)return u=n[a],d=t?t(u):u,new z(d,u.node,z.BLACK,null,null);{let _=parseInt(h/2,10)+a,p=i(a,_),T=i(_+1,c);return u=n[_],d=t?t(u):u,new z(d,u.node,z.BLACK,p,T)}},r=function(a){let c=null,h=null,u=n.length,d=function(p,T){let k=u-p,X=u;u-=p;let ie=i(k+1,X),Re=n[k],Vl=t?t(Re):Re;_(new z(Vl,Re.node,T,null,ie))},_=function(p){c?(c.left=p,c=p):(h=p,c=p)};for(let p=0;p<a.count;++p){let T=a.nextBitIsOne(),k=Math.pow(2,a.count-(p+1));T?d(k,z.BLACK):(d(k,z.BLACK),d(k,z.RED))}return h},o=new ss(n.length),l=r(o);return new q(s||e,l)};var Fn,Ae={},Fe=class n{constructor(e,t){this.indexes_=e,this.indexSet_=t}static get Default(){return f(Ae&&S,"ChildrenNode.ts has not been loaded"),Fn=Fn||new n({".priority":Ae},{".priority":S}),Fn}get(e){let t=le(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof q?t:null}hasIndex(e){return j(this.indexSet_,e.toString())}addIndex(e,t){f(e!==ee,"KeyIndex always exists and isn't meant to be added to the IndexMap.");let s=[],i=!1,r=t.getIterator(C.Wrap),o=r.getNext();for(;o;)i=i||e.isDefinedOn(o.node),s.push(o),o=r.getNext();let l;i?l=Gt(s,e.getCompare()):l=Ae;let a=e.toString(),c=Object.assign({},this.indexSet_);c[a]=e;let h=Object.assign({},this.indexes_);return h[a]=l,new n(h,c)}addToIndexes(e,t){let s=Ye(this.indexes_,(i,r)=>{let o=le(this.indexSet_,r);if(f(o,"Missing index implementation for "+r),i===Ae)if(o.isDefinedOn(e.node)){let l=[],a=t.getIterator(C.Wrap),c=a.getNext();for(;c;)c.name!==e.name&&l.push(c),c=a.getNext();return l.push(e),Gt(l,o.getCompare())}else return Ae;else{let l=t.get(e.name),a=i;return l&&(a=a.remove(new C(e.name,l))),a.insert(e,e.node)}});return new n(s,this.indexSet_)}removeFromIndexes(e,t){let s=Ye(this.indexes_,i=>{if(i===Ae)return i;{let r=t.get(e.name);return r?i.remove(new C(e.name,r)):i}});return new n(s,this.indexSet_)}};var Je,m=(()=>{class n{constructor(t,s,i){this.children_=t,this.priorityNode_=s,this.indexMap_=i,this.lazyHash_=null,this.priorityNode_&&Eo(this.priorityNode_),this.children_.isEmpty()&&f(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}static get EMPTY_NODE(){return Je||(Je=new n(new q(Js),null,Fe.Default))}isLeafNode(){return!1}getPriority(){return this.priorityNode_||Je}updatePriority(t){return this.children_.isEmpty()?this:new n(this.children_,t,this.indexMap_)}getImmediateChild(t){if(t===".priority")return this.getPriority();{let s=this.children_.get(t);return s===null?Je:s}}getChild(t){let s=y(t);return s===null?this:this.getImmediateChild(s).getChild(I(t))}hasChild(t){return this.children_.get(t)!==null}updateImmediateChild(t,s){if(f(s,"We should always be passing snapshot nodes"),t===".priority")return this.updatePriority(s);{let i=new C(t,s),r,o;s.isEmpty()?(r=this.children_.remove(t),o=this.indexMap_.removeFromIndexes(i,this.children_)):(r=this.children_.insert(t,s),o=this.indexMap_.addToIndexes(i,this.children_));let l=r.isEmpty()?Je:this.priorityNode_;return new n(r,l,o)}}updateChild(t,s){let i=y(t);if(i===null)return s;{f(y(t)!==".priority"||de(t)===1,".priority must be the last token in a path");let r=this.getImmediateChild(i).updateChild(I(t),s);return this.updateImmediateChild(i,r)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(t){if(this.isEmpty())return null;let s={},i=0,r=0,o=!0;if(this.forEachChild(S,(l,a)=>{s[l]=a.val(t),i++,o&&n.INTEGER_REGEXP_.test(l)?r=Math.max(r,Number(l)):o=!1}),!t&&o&&r<2*i){let l=[];for(let a in s)l[a]=s[a];return l}else return t&&!this.getPriority().isEmpty()&&(s[".priority"]=this.getPriority().val()),s}hash(){if(this.lazyHash_===null){let t="";this.getPriority().isEmpty()||(t+="priority:"+wo(this.getPriority().val())+":"),this.forEachChild(S,(s,i)=>{let r=i.hash();r!==""&&(t+=":"+s+":"+r)}),this.lazyHash_=t===""?"":Jr(t)}return this.lazyHash_}getPredecessorChildName(t,s,i){let r=this.resolveIndex_(i);if(r){let o=r.getPredecessorKey(new C(t,s));return o?o.name:null}else return this.children_.getPredecessorKey(t)}getFirstChildName(t){let s=this.resolveIndex_(t);if(s){let i=s.minKey();return i&&i.name}else return this.children_.minKey()}getFirstChild(t){let s=this.getFirstChildName(t);return s?new C(s,this.children_.get(s)):null}getLastChildName(t){let s=this.resolveIndex_(t);if(s){let i=s.maxKey();return i&&i.name}else return this.children_.maxKey()}getLastChild(t){let s=this.getLastChildName(t);return s?new C(s,this.children_.get(s)):null}forEachChild(t,s){let i=this.resolveIndex_(t);return i?i.inorderTraversal(r=>s(r.name,r.node)):this.children_.inorderTraversal(s)}getIterator(t){return this.getIteratorFrom(t.minPost(),t)}getIteratorFrom(t,s){let i=this.resolveIndex_(s);if(i)return i.getIteratorFrom(t,r=>r);{let r=this.children_.getIteratorFrom(t.name,C.Wrap),o=r.peek();for(;o!=null&&s.compare(o,t)<0;)r.getNext(),o=r.peek();return r}}getReverseIterator(t){return this.getReverseIteratorFrom(t.maxPost(),t)}getReverseIteratorFrom(t,s){let i=this.resolveIndex_(s);if(i)return i.getReverseIteratorFrom(t,r=>r);{let r=this.children_.getReverseIteratorFrom(t.name,C.Wrap),o=r.peek();for(;o!=null&&s.compare(o,t)>0;)r.getNext(),o=r.peek();return r}}compareTo(t){return this.isEmpty()?t.isEmpty()?0:-1:t.isLeafNode()||t.isEmpty()?1:t===wt?-1:0}withIndex(t){if(t===ee||this.indexMap_.hasIndex(t))return this;{let s=this.indexMap_.addIndex(t,this.children_);return new n(this.children_,this.priorityNode_,s)}}isIndexed(t){return t===ee||this.indexMap_.hasIndex(t)}equals(t){if(t===this)return!0;if(t.isLeafNode())return!1;{let s=t;if(this.getPriority().equals(s.getPriority()))if(this.children_.count()===s.children_.count()){let i=this.getIterator(S),r=s.getIterator(S),o=i.getNext(),l=r.getNext();for(;o&&l;){if(o.name!==l.name||!o.node.equals(l.node))return!1;o=i.getNext(),l=r.getNext()}return o===null&&l===null}else return!1;else return!1}}resolveIndex_(t){return t===ee?null:this.indexMap_.get(t.toString())}}return n.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,n})(),is=class extends m{constructor(){super(new q(Js),m.EMPTY_NODE,Fe.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return m.EMPTY_NODE}isEmpty(){return!1}},wt=new is;Object.defineProperties(C,{MIN:{value:new C(ue,m.EMPTY_NODE)},MAX:{value:new C(re,wt)}});Vt.__EMPTY_NODE=m.EMPTY_NODE;Le.__childrenNodeConstructor=m;Pa(wt);Aa(wt);var Da=!0;function N(n,e=null){if(n===null)return m.EMPTY_NODE;if(typeof n=="object"&&".priority"in n&&(e=n[".priority"]),f(e===null||typeof e=="string"||typeof e=="number"||typeof e=="object"&&".sv"in e,"Invalid priority type found: "+typeof e),typeof n=="object"&&".value"in n&&n[".value"]!==null&&(n=n[".value"]),typeof n!="object"||".sv"in n){let t=n;return new Le(t,N(e))}if(!(n instanceof Array)&&Da){let t=[],s=!1;if(x(n,(o,l)=>{if(o.substring(0,1)!=="."){let a=N(l);a.isEmpty()||(s=s||!a.getPriority().isEmpty(),t.push(new C(o,a)))}}),t.length===0)return m.EMPTY_NODE;let r=Gt(t,Ra,o=>o.name,Js);if(s){let o=Gt(t,S.getCompare());return new m(r,N(e),new Fe({".priority":o},{".priority":S}))}else return new m(r,N(e),Fe.Default)}else{let t=m.EMPTY_NODE;return x(n,(s,i)=>{if(j(n,s)&&s.substring(0,1)!=="."){let r=N(i);(r.isLeafNode()||!r.isEmpty())&&(t=t.updateImmediateChild(s,r))}}),t.updatePriority(N(e))}}ka(N);var lt=class extends Me{constructor(e){super(),this.indexPath_=e,f(!v(e)&&y(e)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){let s=this.extractChild(e.node),i=this.extractChild(t.node),r=s.compareTo(i);return r===0?Te(e.name,t.name):r}makePost(e,t){let s=N(e),i=m.EMPTY_NODE.updateChild(this.indexPath_,s);return new C(t,i)}maxPost(){let e=m.EMPTY_NODE.updateChild(this.indexPath_,wt);return new C(re,e)}toString(){return ot(this.indexPath_,0).join("/")}};var rs=class extends Me{compare(e,t){let s=e.node.compareTo(t.node);return s===0?Te(e.name,t.name):s}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return C.MIN}maxPost(){return C.MAX}makePost(e,t){let s=N(e);return new C(t,s)}toString(){return".value"}},Zs=new rs;function So(n){return{type:"value",snapshotNode:n}}function We(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function at(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function ct(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}function Oa(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}var ht=class{constructor(e){this.index_=e}updateChild(e,t,s,i,r,o){f(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");let l=e.getImmediateChild(t);return l.getChild(i).equals(s.getChild(i))&&l.isEmpty()===s.isEmpty()||(o!=null&&(s.isEmpty()?e.hasChild(t)?o.trackChildChange(at(t,l)):f(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):l.isEmpty()?o.trackChildChange(We(t,s)):o.trackChildChange(ct(t,s,l))),e.isLeafNode()&&s.isEmpty())?e:e.updateImmediateChild(t,s).withIndex(this.index_)}updateFullNode(e,t,s){return s!=null&&(e.isLeafNode()||e.forEachChild(S,(i,r)=>{t.hasChild(i)||s.trackChildChange(at(i,r))}),t.isLeafNode()||t.forEachChild(S,(i,r)=>{if(e.hasChild(i)){let o=e.getImmediateChild(i);o.equals(r)||s.trackChildChange(ct(i,r,o))}else s.trackChildChange(We(i,r))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?m.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}};var Ht=class n{constructor(e){this.indexedFilter_=new ht(e.getIndex()),this.index_=e.getIndex(),this.startPost_=n.getStartPost_(e),this.endPost_=n.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){let t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,s=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&s}updateChild(e,t,s,i,r,o){return this.matches(new C(t,s))||(s=m.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,s,i,r,o)}updateFullNode(e,t,s){t.isLeafNode()&&(t=m.EMPTY_NODE);let i=t.withIndex(this.index_);i=i.updatePriority(m.EMPTY_NODE);let r=this;return t.forEachChild(S,(o,l)=>{r.matches(new C(o,l))||(i=i.updateImmediateChild(o,m.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){let t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){let t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}};var os=class{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{let s=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?s<=0:s<0},this.withinEndPost=t=>{let s=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?s<=0:s<0},this.rangedFilter_=new Ht(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,s,i,r,o){return this.rangedFilter_.matches(new C(t,s))||(s=m.EMPTY_NODE),e.getImmediateChild(t).equals(s)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,s,i,r,o):this.fullLimitUpdateChild_(e,t,s,r,o)}updateFullNode(e,t,s){let i;if(t.isLeafNode()||t.isEmpty())i=m.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){i=m.EMPTY_NODE.withIndex(this.index_);let r;this.reverse_?r=t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):r=t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;r.hasNext()&&o<this.limit_;){let l=r.getNext();if(this.withinDirectionalStart(l))if(this.withinDirectionalEnd(l))i=i.updateImmediateChild(l.name,l.node),o++;else break;else continue}}else{i=t.withIndex(this.index_),i=i.updatePriority(m.EMPTY_NODE);let r;this.reverse_?r=i.getReverseIterator(this.index_):r=i.getIterator(this.index_);let o=0;for(;r.hasNext();){let l=r.getNext();o<this.limit_&&this.withinDirectionalStart(l)&&this.withinDirectionalEnd(l)?o++:i=i.updateImmediateChild(l.name,m.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,s,i,r){let o;if(this.reverse_){let u=this.index_.getCompare();o=(d,_)=>u(_,d)}else o=this.index_.getCompare();let l=e;f(l.numChildren()===this.limit_,"");let a=new C(t,s),c=this.reverse_?l.getFirstChild(this.index_):l.getLastChild(this.index_),h=this.rangedFilter_.matches(a);if(l.hasChild(t)){let u=l.getImmediateChild(t),d=i.getChildAfterChild(this.index_,c,this.reverse_);for(;d!=null&&(d.name===t||l.hasChild(d.name));)d=i.getChildAfterChild(this.index_,d,this.reverse_);let _=d==null?1:o(d,a);if(h&&!s.isEmpty()&&_>=0)return r?.trackChildChange(ct(t,s,u)),l.updateImmediateChild(t,s);{r?.trackChildChange(at(t,u));let T=l.updateImmediateChild(t,m.EMPTY_NODE);return d!=null&&this.rangedFilter_.matches(d)?(r?.trackChildChange(We(d.name,d.node)),T.updateImmediateChild(d.name,d.node)):T}}else return s.isEmpty()?e:h&&o(c,a)>=0?(r!=null&&(r.trackChildChange(at(c.name,c.node)),r.trackChildChange(We(t,s))),l.updateImmediateChild(t,s).updateImmediateChild(c.name,m.EMPTY_NODE)):e}};var ut=class n{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=S}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return f(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return f(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:ue}hasEnd(){return this.endSet_}getIndexEndValue(){return f(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return f(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:re}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return f(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===S}copy(){let e=new n;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}};function Ma(n){return n.loadsAllData()?new ht(n.getIndex()):n.hasLimit()?new os(n):new Ht(n)}function La(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="l",t}function Fa(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="r",t}function ls(n,e,t){let s=n.copy();return s.startSet_=!0,e===void 0&&(e=null),s.indexStartValue_=e,t!=null?(s.startNameSet_=!0,s.indexStartName_=t):(s.startNameSet_=!1,s.indexStartName_=""),s}function Wa(n,e,t){let s;return n.index_===ee||t?s=ls(n,e,t):s=ls(n,e,re),s.startAfterSet_=!0,s}function as(n,e,t){let s=n.copy();return s.endSet_=!0,e===void 0&&(e=null),s.indexEndValue_=e,t!==void 0?(s.endNameSet_=!0,s.indexEndName_=t):(s.endNameSet_=!1,s.indexEndName_=""),s}function Ua(n,e,t){let s;return n.index_===ee||t?s=as(n,e,t):s=as(n,e,ue),s.endBeforeSet_=!0,s}function cn(n,e){let t=n.copy();return t.index_=e,t}function Or(n){let e={};if(n.isDefault())return e;let t;if(n.index_===S?t="$priority":n.index_===Zs?t="$value":n.index_===ee?t="$key":(f(n.index_ instanceof lt,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=R(t),n.startSet_){let s=n.startAfterSet_?"startAfter":"startAt";e[s]=R(n.indexStartValue_),n.startNameSet_&&(e[s]+=","+R(n.indexStartName_))}if(n.endSet_){let s=n.endBeforeSet_?"endBefore":"endAt";e[s]=R(n.indexEndValue_),n.endNameSet_&&(e[s]+=","+R(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function Mr(n){let e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;t===""&&(n.isViewFromLeft()?t="l":t="r"),e.vf=t}return n.index_!==S&&(e.i=n.index_.toString()),e}var cs=class n extends Wt{constructor(e,t,s,i){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=s,this.appCheckTokenProvider_=i,this.log_=Ct("p:rest:"),this.listens_={}}reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return t!==void 0?"tag$"+t:(f(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}listen(e,t,s,i){let r=e._path.toString();this.log_("Listen called for "+r+" "+e._queryIdentifier);let o=n.getListenId_(e,s),l={};this.listens_[o]=l;let a=Or(e._queryParams);this.restRequest_(r+".json",a,(c,h)=>{let u=h;if(c===404&&(u=null,c=null),c===null&&this.onDataUpdate_(r,u,!1,s),le(this.listens_,o)===l){let d;c?c===401?d="permission_denied":d="rest_error:"+c:d="ok",i(d,null)}})}unlisten(e,t){let s=n.getListenId_(e,t);delete this.listens_[s]}get(e){let t=Or(e._queryParams),s=e._path.toString(),i=new M;return this.restRequest_(s+".json",t,(r,o)=>{let l=o;r===404&&(l=null,r=null),r===null?(this.onDataUpdate_(s,l,!1,null),i.resolve(l)):i.reject(new Error(l))}),i.promise}refreshAuthToken(e){}restRequest_(e,t={},s){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([i,r])=>{i&&i.accessToken&&(t.auth=i.accessToken),r&&r.token&&(t.ac=r.token);let o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+Xi(t);this.log_("Sending REST request for "+o);let l=new XMLHttpRequest;l.onreadystatechange=()=>{if(s&&l.readyState===4){this.log_("REST Response for "+o+" received. status:",l.status,"response:",l.responseText);let a=null;if(l.status>=200&&l.status<300){try{a=Pt(l.responseText)}catch{O("Failed to parse JSON response for "+o+": "+l.responseText)}s(null,a)}else l.status!==401&&l.status!==404&&O("Got unsuccessful REST response for "+o+" Status: "+l.status),s(l.status);s=null}},l.open("GET",o,!0),l.send()})}};var hs=class{constructor(){this.rootNode_=m.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}};function Qt(){return{value:null,children:new Map}}function Qe(n,e,t){if(v(e))n.value=t,n.children.clear();else if(n.value!==null)n.value=n.value.updateChild(e,t);else{let s=y(e);n.children.has(s)||n.children.set(s,Qt());let i=n.children.get(s);e=I(e),Qe(i,e,t)}}function us(n,e){if(v(e))return n.value=null,n.children.clear(),!0;if(n.value!==null){if(n.value.isLeafNode())return!1;{let t=n.value;return n.value=null,t.forEachChild(S,(s,i)=>{Qe(n,new E(s),i)}),us(n,e)}}else if(n.children.size>0){let t=y(e);return e=I(e),n.children.has(t)&&us(n.children.get(t),e)&&n.children.delete(t),n.children.size===0}else return!0}function ds(n,e,t){n.value!==null?t(e,n.value):Ba(n,(s,i)=>{let r=new E(e.toString()+"/"+s);ds(i,r,t)})}function Ba(n,e){n.children.forEach((t,s)=>{e(s,t)})}var fs=class{constructor(e){this.collection_=e,this.last_=null}get(){let e=this.collection_.get(),t=Object.assign({},e);return this.last_&&x(this.last_,(s,i)=>{t[s]=t[s]-i}),this.last_=e,t}};var Lr=10*1e3,Va=30*1e3,Ga=5*60*1e3,_s=class{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new fs(e);let s=Lr+(Va-Lr)*Math.random();et(this.reportStats_.bind(this),Math.floor(s))}reportStats_(){let e=this.statsListener_.get(),t={},s=!1;x(e,(i,r)=>{r>0&&j(this.statsToReport_,i)&&(t[i]=r,s=!0)}),s&&this.server_.reportStats(t),et(this.reportStats_.bind(this),Math.floor(Math.random()*2*Ga))}};var Z=function(n){return n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE",n}(Z||{});function ei(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function ti(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function ni(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}var ps=class n{constructor(e,t,s){this.path=e,this.affectedTree=t,this.revert=s,this.type=Z.ACK_USER_WRITE,this.source=ei()}operationForChild(e){if(v(this.path)){if(this.affectedTree.value!=null)return f(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{let t=this.affectedTree.subtree(new E(e));return new n(w(),t,this.revert)}}else return f(y(this.path)===e,"operationForChild called for unrelated child."),new n(I(this.path),this.affectedTree,this.revert)}};var jt=class n{constructor(e,t){this.source=e,this.path=t,this.type=Z.LISTEN_COMPLETE}operationForChild(e){return v(this.path)?new n(this.source,w()):new n(this.source,I(this.path))}};var Ue=class n{constructor(e,t,s){this.source=e,this.path=t,this.snap=s,this.type=Z.OVERWRITE}operationForChild(e){return v(this.path)?new n(this.source,w(),this.snap.getImmediateChild(e)):new n(this.source,I(this.path),this.snap)}};var dt=class n{constructor(e,t,s){this.source=e,this.path=t,this.children=s,this.type=Z.MERGE}operationForChild(e){if(v(this.path)){let t=this.children.subtree(new E(e));return t.isEmpty()?null:t.value?new Ue(this.source,w(),t.value):new n(this.source,w(),t)}else return f(y(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new n(this.source,I(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}};var ne=class{constructor(e,t,s){this.node_=e,this.fullyInitialized_=t,this.filtered_=s}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(v(e))return this.isFullyInitialized()&&!this.filtered_;let t=y(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}};var gs=class{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}};function Ha(n,e,t,s){let i=[],r=[];return e.forEach(o=>{o.type==="child_changed"&&n.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&r.push(Oa(o.childName,o.snapshotNode))}),Ze(n,i,"child_removed",e,s,t),Ze(n,i,"child_added",e,s,t),Ze(n,i,"child_moved",r,s,t),Ze(n,i,"child_changed",e,s,t),Ze(n,i,"value",e,s,t),i}function Ze(n,e,t,s,i,r){let o=s.filter(l=>l.type===t);o.sort((l,a)=>ja(n,l,a)),o.forEach(l=>{let a=Qa(n,l,r);i.forEach(c=>{c.respondsTo(l.type)&&e.push(c.createEvent(a,n.query_))})})}function Qa(n,e,t){return e.type==="value"||e.type==="child_removed"||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}function ja(n,e,t){if(e.childName==null||t.childName==null)throw Pe("Should only compare child_ events.");let s=new C(e.childName,e.snapshotNode),i=new C(t.childName,t.snapshotNode);return n.index_.compare(s,i)}function hn(n,e){return{eventCache:n,serverCache:e}}function nt(n,e,t,s){return hn(new ne(e,t,s),n.serverCache)}function bo(n,e,t,s){return hn(n.eventCache,new ne(e,t,s))}function Kt(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function Ee(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}var Wn,Ka=()=>(Wn||(Wn=new q(Ql)),Wn),F=class n{constructor(e,t=Ka()){this.value=e,this.children=t}static fromObject(e){let t=new n(null);return x(e,(s,i)=>{t=t.set(new E(s),i)}),t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:w(),value:this.value};if(v(e))return null;{let s=y(e),i=this.children.get(s);if(i!==null){let r=i.findRootMostMatchingPathAndValue(I(e),t);return r!=null?{path:b(new E(s),r.path),value:r.value}:null}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(v(e))return this;{let t=y(e),s=this.children.get(t);return s!==null?s.subtree(I(e)):new n(null)}}set(e,t){if(v(e))return new n(t,this.children);{let s=y(e),r=(this.children.get(s)||new n(null)).set(I(e),t),o=this.children.insert(s,r);return new n(this.value,o)}}remove(e){if(v(e))return this.children.isEmpty()?new n(null):new n(null,this.children);{let t=y(e),s=this.children.get(t);if(s){let i=s.remove(I(e)),r;return i.isEmpty()?r=this.children.remove(t):r=this.children.insert(t,i),this.value===null&&r.isEmpty()?new n(null):new n(this.value,r)}else return this}}get(e){if(v(e))return this.value;{let t=y(e),s=this.children.get(t);return s?s.get(I(e)):null}}setTree(e,t){if(v(e))return t;{let s=y(e),r=(this.children.get(s)||new n(null)).setTree(I(e),t),o;return r.isEmpty()?o=this.children.remove(s):o=this.children.insert(s,r),new n(this.value,o)}}fold(e){return this.fold_(w(),e)}fold_(e,t){let s={};return this.children.inorderTraversal((i,r)=>{s[i]=r.fold_(b(e,i),t)}),t(e,this.value,s)}findOnPath(e,t){return this.findOnPath_(e,w(),t)}findOnPath_(e,t,s){let i=this.value?s(t,this.value):!1;if(i)return i;if(v(e))return null;{let r=y(e),o=this.children.get(r);return o?o.findOnPath_(I(e),b(t,r),s):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,w(),t)}foreachOnPath_(e,t,s){if(v(e))return this;{this.value&&s(t,this.value);let i=y(e),r=this.children.get(i);return r?r.foreachOnPath_(I(e),b(t,i),s):new n(null)}}foreach(e){this.foreach_(w(),e)}foreach_(e,t){this.children.inorderTraversal((s,i)=>{i.foreach_(b(e,s),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,s)=>{s.value&&e(t,s.value)})}};var $=class n{constructor(e){this.writeTree_=e}static empty(){return new n(new F(null))}};function st(n,e,t){if(v(e))return new $(new F(t));{let s=n.writeTree_.findRootMostValueAndPath(e);if(s!=null){let i=s.path,r=s.value,o=L(i,e);return r=r.updateChild(o,t),new $(n.writeTree_.set(i,r))}else{let i=new F(t),r=n.writeTree_.setTree(e,i);return new $(r)}}}function ms(n,e,t){let s=n;return x(t,(i,r)=>{s=st(s,b(e,i),r)}),s}function Fr(n,e){if(v(e))return $.empty();{let t=n.writeTree_.setTree(e,new F(null));return new $(t)}}function ys(n,e){return Ie(n,e)!=null}function Ie(n,e){let t=n.writeTree_.findRootMostValueAndPath(e);return t!=null?n.writeTree_.get(t.path).getChild(L(t.path,e)):null}function Wr(n){let e=[],t=n.writeTree_.value;return t!=null?t.isLeafNode()||t.forEachChild(S,(s,i)=>{e.push(new C(s,i))}):n.writeTree_.children.inorderTraversal((s,i)=>{i.value!=null&&e.push(new C(s,i.value))}),e}function ce(n,e){if(v(e))return n;{let t=Ie(n,e);return t!=null?new $(new F(t)):new $(n.writeTree_.subtree(e))}}function vs(n){return n.writeTree_.isEmpty()}function Be(n,e){return No(w(),n.writeTree_,e)}function No(n,e,t){if(e.value!=null)return t.updateChild(n,e.value);{let s=null;return e.children.inorderTraversal((i,r)=>{i===".priority"?(f(r.value!==null,"Priority writes must always be leaf nodes"),s=r.value):t=No(b(n,i),r,t)}),!t.getChild(n).isEmpty()&&s!==null&&(t=t.updateChild(b(n,".priority"),s)),t}}function un(n,e){return Ao(e,n)}function qa(n,e,t,s,i){f(s>n.lastWriteId,"Stacking an older write on top of newer ones"),i===void 0&&(i=!0),n.allWrites.push({path:e,snap:t,writeId:s,visible:i}),i&&(n.visibleWrites=st(n.visibleWrites,e,t)),n.lastWriteId=s}function Ya(n,e,t,s){f(s>n.lastWriteId,"Stacking an older merge on top of newer ones"),n.allWrites.push({path:e,children:t,writeId:s,visible:!0}),n.visibleWrites=ms(n.visibleWrites,e,t),n.lastWriteId=s}function za(n,e){for(let t=0;t<n.allWrites.length;t++){let s=n.allWrites[t];if(s.writeId===e)return s}return null}function $a(n,e){let t=n.allWrites.findIndex(l=>l.writeId===e);f(t>=0,"removeWrite called with nonexistent writeId.");let s=n.allWrites[t];n.allWrites.splice(t,1);let i=s.visible,r=!1,o=n.allWrites.length-1;for(;i&&o>=0;){let l=n.allWrites[o];l.visible&&(o>=t&&Xa(l,s.path)?i=!1:K(s.path,l.path)&&(r=!0)),o--}if(i){if(r)return Ja(n),!0;if(s.snap)n.visibleWrites=Fr(n.visibleWrites,s.path);else{let l=s.children;x(l,a=>{n.visibleWrites=Fr(n.visibleWrites,b(s.path,a))})}return!0}else return!1}function Xa(n,e){if(n.snap)return K(n.path,e);for(let t in n.children)if(n.children.hasOwnProperty(t)&&K(b(n.path,t),e))return!0;return!1}function Ja(n){n.visibleWrites=Ro(n.allWrites,Za,w()),n.allWrites.length>0?n.lastWriteId=n.allWrites[n.allWrites.length-1].writeId:n.lastWriteId=-1}function Za(n){return n.visible}function Ro(n,e,t){let s=$.empty();for(let i=0;i<n.length;++i){let r=n[i];if(e(r)){let o=r.path,l;if(r.snap)K(t,o)?(l=L(t,o),s=st(s,l,r.snap)):K(o,t)&&(l=L(o,t),s=st(s,w(),r.snap.getChild(l)));else if(r.children){if(K(t,o))l=L(t,o),s=ms(s,l,r.children);else if(K(o,t))if(l=L(o,t),v(l))s=ms(s,w(),r.children);else{let a=le(r.children,y(l));if(a){let c=a.getChild(I(l));s=st(s,w(),c)}}}else throw Pe("WriteRecord should have .snap or .children")}}return s}function Po(n,e,t,s,i){if(!s&&!i){let r=Ie(n.visibleWrites,e);if(r!=null)return r;{let o=ce(n.visibleWrites,e);if(vs(o))return t;if(t==null&&!ys(o,w()))return null;{let l=t||m.EMPTY_NODE;return Be(o,l)}}}else{let r=ce(n.visibleWrites,e);if(!i&&vs(r))return t;if(!i&&t==null&&!ys(r,w()))return null;{let o=function(c){return(c.visible||i)&&(!s||!~s.indexOf(c.writeId))&&(K(c.path,e)||K(e,c.path))},l=Ro(n.allWrites,o,e),a=t||m.EMPTY_NODE;return Be(l,a)}}}function ec(n,e,t){let s=m.EMPTY_NODE,i=Ie(n.visibleWrites,e);if(i)return i.isLeafNode()||i.forEachChild(S,(r,o)=>{s=s.updateImmediateChild(r,o)}),s;if(t){let r=ce(n.visibleWrites,e);return t.forEachChild(S,(o,l)=>{let a=Be(ce(r,new E(o)),l);s=s.updateImmediateChild(o,a)}),Wr(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}else{let r=ce(n.visibleWrites,e);return Wr(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}}function tc(n,e,t,s,i){f(s||i,"Either existingEventSnap or existingServerSnap must exist");let r=b(e,t);if(ys(n.visibleWrites,r))return null;{let o=ce(n.visibleWrites,r);return vs(o)?i.getChild(t):Be(o,i.getChild(t))}}function nc(n,e,t,s){let i=b(e,t),r=Ie(n.visibleWrites,i);if(r!=null)return r;if(s.isCompleteForChild(t)){let o=ce(n.visibleWrites,i);return Be(o,s.getNode().getImmediateChild(t))}else return null}function sc(n,e){return Ie(n.visibleWrites,e)}function ic(n,e,t,s,i,r,o){let l,a=ce(n.visibleWrites,e),c=Ie(a,w());if(c!=null)l=c;else if(t!=null)l=Be(a,t);else return[];if(l=l.withIndex(o),!l.isEmpty()&&!l.isLeafNode()){let h=[],u=o.getCompare(),d=r?l.getReverseIteratorFrom(s,o):l.getIteratorFrom(s,o),_=d.getNext();for(;_&&h.length<i;)u(_,s)!==0&&h.push(_),_=d.getNext();return h}else return[]}function rc(){return{visibleWrites:$.empty(),allWrites:[],lastWriteId:-1}}function qt(n,e,t,s){return Po(n.writeTree,n.treePath,e,t,s)}function si(n,e){return ec(n.writeTree,n.treePath,e)}function Ur(n,e,t,s){return tc(n.writeTree,n.treePath,e,t,s)}function Yt(n,e){return sc(n.writeTree,b(n.treePath,e))}function oc(n,e,t,s,i,r){return ic(n.writeTree,n.treePath,e,t,s,i,r)}function ii(n,e,t){return nc(n.writeTree,n.treePath,e,t)}function ko(n,e){return Ao(b(n.treePath,e),n.writeTree)}function Ao(n,e){return{treePath:n,writeTree:e}}var Cs=class{constructor(){this.changeMap=new Map}trackChildChange(e){let t=e.type,s=e.childName;f(t==="child_added"||t==="child_changed"||t==="child_removed","Only child changes supported for tracking"),f(s!==".priority","Only non-priority child changes can be tracked.");let i=this.changeMap.get(s);if(i){let r=i.type;if(t==="child_added"&&r==="child_removed")this.changeMap.set(s,ct(s,e.snapshotNode,i.snapshotNode));else if(t==="child_removed"&&r==="child_added")this.changeMap.delete(s);else if(t==="child_removed"&&r==="child_changed")this.changeMap.set(s,at(s,i.oldSnap));else if(t==="child_changed"&&r==="child_added")this.changeMap.set(s,We(s,e.snapshotNode));else if(t==="child_changed"&&r==="child_changed")this.changeMap.set(s,ct(s,e.snapshotNode,i.oldSnap));else throw Pe("Illegal combination of changes: "+e+" occurred after "+i)}else this.changeMap.set(s,e)}getChanges(){return Array.from(this.changeMap.values())}};var ws=class{getCompleteChild(e){return null}getChildAfterChild(e,t,s){return null}},xo=new ws,ft=class{constructor(e,t,s=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=s}getCompleteChild(e){let t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{let s=this.optCompleteServerCache_!=null?new ne(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return ii(this.writes_,e,s)}}getChildAfterChild(e,t,s){let i=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:Ee(this.viewCache_),r=oc(this.writes_,i,t,1,s,e);return r.length===0?null:r[0]}};function lc(n){return{filter:n}}function ac(n,e){f(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),f(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}function cc(n,e,t,s,i){let r=new Cs,o,l;if(t.type===Z.OVERWRITE){let c=t;c.source.fromUser?o=Es(n,e,c.path,c.snap,s,i,r):(f(c.source.fromServer,"Unknown source."),l=c.source.tagged||e.serverCache.isFiltered()&&!v(c.path),o=zt(n,e,c.path,c.snap,s,i,l,r))}else if(t.type===Z.MERGE){let c=t;c.source.fromUser?o=uc(n,e,c.path,c.children,s,i,r):(f(c.source.fromServer,"Unknown source."),l=c.source.tagged||e.serverCache.isFiltered(),o=Ts(n,e,c.path,c.children,s,i,l,r))}else if(t.type===Z.ACK_USER_WRITE){let c=t;c.revert?o=_c(n,e,c.path,s,i,r):o=dc(n,e,c.path,c.affectedTree,s,i,r)}else if(t.type===Z.LISTEN_COMPLETE)o=fc(n,e,t.path,s,r);else throw Pe("Unknown operation type: "+t.type);let a=r.getChanges();return hc(e,o,a),{viewCache:o,changes:a}}function hc(n,e,t){let s=e.eventCache;if(s.isFullyInitialized()){let i=s.getNode().isLeafNode()||s.getNode().isEmpty(),r=Kt(n);(t.length>0||!n.eventCache.isFullyInitialized()||i&&!s.getNode().equals(r)||!s.getNode().getPriority().equals(r.getPriority()))&&t.push(So(Kt(e)))}}function Do(n,e,t,s,i,r){let o=e.eventCache;if(Yt(s,t)!=null)return e;{let l,a;if(v(t))if(f(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){let c=Ee(e),h=c instanceof m?c:m.EMPTY_NODE,u=si(s,h);l=n.filter.updateFullNode(e.eventCache.getNode(),u,r)}else{let c=qt(s,Ee(e));l=n.filter.updateFullNode(e.eventCache.getNode(),c,r)}else{let c=y(t);if(c===".priority"){f(de(t)===1,"Can't have a priority with additional path components");let h=o.getNode();a=e.serverCache.getNode();let u=Ur(s,t,h,a);u!=null?l=n.filter.updatePriority(h,u):l=o.getNode()}else{let h=I(t),u;if(o.isCompleteForChild(c)){a=e.serverCache.getNode();let d=Ur(s,t,o.getNode(),a);d!=null?u=o.getNode().getImmediateChild(c).updateChild(h,d):u=o.getNode().getImmediateChild(c)}else u=ii(s,c,e.serverCache);u!=null?l=n.filter.updateChild(o.getNode(),c,u,h,i,r):l=o.getNode()}}return nt(e,l,o.isFullyInitialized()||v(t),n.filter.filtersNodes())}}function zt(n,e,t,s,i,r,o,l){let a=e.serverCache,c,h=o?n.filter:n.filter.getIndexedFilter();if(v(t))c=h.updateFullNode(a.getNode(),s,null);else if(h.filtersNodes()&&!a.isFiltered()){let _=a.getNode().updateChild(t,s);c=h.updateFullNode(a.getNode(),_,null)}else{let _=y(t);if(!a.isCompleteForPath(t)&&de(t)>1)return e;let p=I(t),k=a.getNode().getImmediateChild(_).updateChild(p,s);_===".priority"?c=h.updatePriority(a.getNode(),k):c=h.updateChild(a.getNode(),_,k,p,xo,null)}let u=bo(e,c,a.isFullyInitialized()||v(t),h.filtersNodes()),d=new ft(i,u,r);return Do(n,u,t,i,d,l)}function Es(n,e,t,s,i,r,o){let l=e.eventCache,a,c,h=new ft(i,e,r);if(v(t))c=n.filter.updateFullNode(e.eventCache.getNode(),s,o),a=nt(e,c,!0,n.filter.filtersNodes());else{let u=y(t);if(u===".priority")c=n.filter.updatePriority(e.eventCache.getNode(),s),a=nt(e,c,l.isFullyInitialized(),l.isFiltered());else{let d=I(t),_=l.getNode().getImmediateChild(u),p;if(v(d))p=s;else{let T=h.getCompleteChild(u);T!=null?zs(d)===".priority"&&T.getChild(vo(d)).isEmpty()?p=T:p=T.updateChild(d,s):p=m.EMPTY_NODE}if(_.equals(p))a=e;else{let T=n.filter.updateChild(l.getNode(),u,p,d,h,o);a=nt(e,T,l.isFullyInitialized(),n.filter.filtersNodes())}}}return a}function Br(n,e){return n.eventCache.isCompleteForChild(e)}function uc(n,e,t,s,i,r,o){let l=e;return s.foreach((a,c)=>{let h=b(t,a);Br(e,y(h))&&(l=Es(n,l,h,c,i,r,o))}),s.foreach((a,c)=>{let h=b(t,a);Br(e,y(h))||(l=Es(n,l,h,c,i,r,o))}),l}function Vr(n,e,t){return t.foreach((s,i)=>{e=e.updateChild(s,i)}),e}function Ts(n,e,t,s,i,r,o,l){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let a=e,c;v(t)?c=s:c=new F(null).setTree(t,s);let h=e.serverCache.getNode();return c.children.inorderTraversal((u,d)=>{if(h.hasChild(u)){let _=e.serverCache.getNode().getImmediateChild(u),p=Vr(n,_,d);a=zt(n,a,new E(u),p,i,r,o,l)}}),c.children.inorderTraversal((u,d)=>{let _=!e.serverCache.isCompleteForChild(u)&&d.value===null;if(!h.hasChild(u)&&!_){let p=e.serverCache.getNode().getImmediateChild(u),T=Vr(n,p,d);a=zt(n,a,new E(u),T,i,r,o,l)}}),a}function dc(n,e,t,s,i,r,o){if(Yt(i,t)!=null)return e;let l=e.serverCache.isFiltered(),a=e.serverCache;if(s.value!=null){if(v(t)&&a.isFullyInitialized()||a.isCompleteForPath(t))return zt(n,e,t,a.getNode().getChild(t),i,r,l,o);if(v(t)){let c=new F(null);return a.getNode().forEachChild(ee,(h,u)=>{c=c.set(new E(h),u)}),Ts(n,e,t,c,i,r,l,o)}else return e}else{let c=new F(null);return s.foreach((h,u)=>{let d=b(t,h);a.isCompleteForPath(d)&&(c=c.set(h,a.getNode().getChild(d)))}),Ts(n,e,t,c,i,r,l,o)}}function fc(n,e,t,s,i){let r=e.serverCache,o=bo(e,r.getNode(),r.isFullyInitialized()||v(t),r.isFiltered());return Do(n,o,t,s,xo,i)}function _c(n,e,t,s,i,r){let o;if(Yt(s,t)!=null)return e;{let l=new ft(s,e,i),a=e.eventCache.getNode(),c;if(v(t)||y(t)===".priority"){let h;if(e.serverCache.isFullyInitialized())h=qt(s,Ee(e));else{let u=e.serverCache.getNode();f(u instanceof m,"serverChildren would be complete if leaf node"),h=si(s,u)}h=h,c=n.filter.updateFullNode(a,h,r)}else{let h=y(t),u=ii(s,h,e.serverCache);u==null&&e.serverCache.isCompleteForChild(h)&&(u=a.getImmediateChild(h)),u!=null?c=n.filter.updateChild(a,h,u,I(t),l,r):e.eventCache.getNode().hasChild(h)?c=n.filter.updateChild(a,h,m.EMPTY_NODE,I(t),l,r):c=a,c.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=qt(s,Ee(e)),o.isLeafNode()&&(c=n.filter.updateFullNode(c,o,r)))}return o=e.serverCache.isFullyInitialized()||Yt(s,w())!=null,nt(e,c,o,n.filter.filtersNodes())}}var Is=class{constructor(e,t){this.query_=e,this.eventRegistrations_=[];let s=this.query_._queryParams,i=new ht(s.getIndex()),r=Ma(s);this.processor_=lc(r);let o=t.serverCache,l=t.eventCache,a=i.updateFullNode(m.EMPTY_NODE,o.getNode(),null),c=r.updateFullNode(m.EMPTY_NODE,l.getNode(),null),h=new ne(a,o.isFullyInitialized(),i.filtersNodes()),u=new ne(c,l.isFullyInitialized(),r.filtersNodes());this.viewCache_=hn(u,h),this.eventGenerator_=new gs(this.query_)}get query(){return this.query_}};function pc(n){return n.viewCache_.serverCache.getNode()}function gc(n){return Kt(n.viewCache_)}function mc(n,e){let t=Ee(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!v(e)&&!t.getImmediateChild(y(e)).isEmpty())?t.getChild(e):null}function Gr(n){return n.eventRegistrations_.length===0}function yc(n,e){n.eventRegistrations_.push(e)}function Hr(n,e,t){let s=[];if(t){f(e==null,"A cancel should cancel all event registrations.");let i=n.query._path;n.eventRegistrations_.forEach(r=>{let o=r.createCancelEvent(t,i);o&&s.push(o)})}if(e){let i=[];for(let r=0;r<n.eventRegistrations_.length;++r){let o=n.eventRegistrations_[r];if(!o.matches(e))i.push(o);else if(e.hasAnyCallback()){i=i.concat(n.eventRegistrations_.slice(r+1));break}}n.eventRegistrations_=i}else n.eventRegistrations_=[];return s}function Qr(n,e,t,s){e.type===Z.MERGE&&e.source.queryId!==null&&(f(Ee(n.viewCache_),"We should always have a full cache before handling merges"),f(Kt(n.viewCache_),"Missing event cache, even though we have a server cache"));let i=n.viewCache_,r=cc(n.processor_,i,e,t,s);return ac(n.processor_,r.viewCache),f(r.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=r.viewCache,Oo(n,r.changes,r.viewCache.eventCache.getNode(),null)}function vc(n,e){let t=n.viewCache_.eventCache,s=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(S,(r,o)=>{s.push(We(r,o))}),t.isFullyInitialized()&&s.push(So(t.getNode())),Oo(n,s,t.getNode(),e)}function Oo(n,e,t,s){let i=s?[s]:n.eventRegistrations_;return Ha(n.eventGenerator_,e,t,i)}var $t,Xt=class{constructor(){this.views=new Map}};function Cc(n){f(!$t,"__referenceConstructor has already been defined"),$t=n}function wc(){return f($t,"Reference.ts has not been loaded"),$t}function Ec(n){return n.views.size===0}function ri(n,e,t,s){let i=e.source.queryId;if(i!==null){let r=n.views.get(i);return f(r!=null,"SyncTree gave us an op for an invalid query."),Qr(r,e,t,s)}else{let r=[];for(let o of n.views.values())r=r.concat(Qr(o,e,t,s));return r}}function Mo(n,e,t,s,i){let r=e._queryIdentifier,o=n.views.get(r);if(!o){let l=qt(t,i?s:null),a=!1;l?a=!0:s instanceof m?(l=si(t,s),a=!1):(l=m.EMPTY_NODE,a=!1);let c=hn(new ne(l,a,!1),new ne(s,i,!1));return new Is(e,c)}return o}function Tc(n,e,t,s,i,r){let o=Mo(n,e,s,i,r);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,o),yc(o,t),vc(o,t)}function Ic(n,e,t,s){let i=e._queryIdentifier,r=[],o=[],l=fe(n);if(i==="default")for(let[a,c]of n.views.entries())o=o.concat(Hr(c,t,s)),Gr(c)&&(n.views.delete(a),c.query._queryParams.loadsAllData()||r.push(c.query));else{let a=n.views.get(i);a&&(o=o.concat(Hr(a,t,s)),Gr(a)&&(n.views.delete(i),a.query._queryParams.loadsAllData()||r.push(a.query)))}return l&&!fe(n)&&r.push(new(wc())(e._repo,e._path)),{removed:r,events:o}}function Lo(n){let e=[];for(let t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function he(n,e){let t=null;for(let s of n.views.values())t=t||mc(s,e);return t}function Fo(n,e){if(e._queryParams.loadsAllData())return dn(n);{let s=e._queryIdentifier;return n.views.get(s)}}function Wo(n,e){return Fo(n,e)!=null}function fe(n){return dn(n)!=null}function dn(n){for(let e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}var Jt;function Sc(n){f(!Jt,"__referenceConstructor has already been defined"),Jt=n}function bc(){return f(Jt,"Reference.ts has not been loaded"),Jt}var Nc=1,Zt=class{constructor(e){this.listenProvider_=e,this.syncPointTree_=new F(null),this.pendingWriteTree_=rc(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}};function oi(n,e,t,s,i){return qa(n.pendingWriteTree_,e,t,s,i),i?je(n,new Ue(ei(),e,t)):[]}function Rc(n,e,t,s){Ya(n.pendingWriteTree_,e,t,s);let i=F.fromObject(t);return je(n,new dt(ei(),e,i))}function ae(n,e,t=!1){let s=za(n.pendingWriteTree_,e);if($a(n.pendingWriteTree_,e)){let r=new F(null);return s.snap!=null?r=r.set(w(),!0):x(s.children,o=>{r=r.set(new E(o),!0)}),je(n,new ps(s.path,r,t))}else return[]}function Et(n,e,t){return je(n,new Ue(ti(),e,t))}function Pc(n,e,t){let s=F.fromObject(t);return je(n,new dt(ti(),e,s))}function kc(n,e){return je(n,new jt(ti(),e))}function Ac(n,e,t){let s=li(n,t);if(s){let i=ai(s),r=i.path,o=i.queryId,l=L(r,e),a=new jt(ni(o),l);return ci(n,r,a)}else return[]}function en(n,e,t,s,i=!1){let r=e._path,o=n.syncPointTree_.get(r),l=[];if(o&&(e._queryIdentifier==="default"||Wo(o,e))){let a=Ic(o,e,t,s);Ec(o)&&(n.syncPointTree_=n.syncPointTree_.remove(r));let c=a.removed;if(l=a.events,!i){let h=c.findIndex(d=>d._queryParams.loadsAllData())!==-1,u=n.syncPointTree_.findOnPath(r,(d,_)=>fe(_));if(h&&!u){let d=n.syncPointTree_.subtree(r);if(!d.isEmpty()){let _=Oc(d);for(let p=0;p<_.length;++p){let T=_[p],k=T.query,X=Go(n,T);n.listenProvider_.startListening(it(k),_t(n,k),X.hashFn,X.onComplete)}}}!u&&c.length>0&&!s&&(h?n.listenProvider_.stopListening(it(e),null):c.forEach(d=>{let _=n.queryToTagMap.get(_n(d));n.listenProvider_.stopListening(it(d),_)}))}Mc(n,c)}return l}function Uo(n,e,t,s){let i=li(n,s);if(i!=null){let r=ai(i),o=r.path,l=r.queryId,a=L(o,e),c=new Ue(ni(l),a,t);return ci(n,o,c)}else return[]}function xc(n,e,t,s){let i=li(n,s);if(i){let r=ai(i),o=r.path,l=r.queryId,a=L(o,e),c=F.fromObject(t),h=new dt(ni(l),a,c);return ci(n,o,h)}else return[]}function Ss(n,e,t,s=!1){let i=e._path,r=null,o=!1;n.syncPointTree_.foreachOnPath(i,(d,_)=>{let p=L(d,i);r=r||he(_,p),o=o||fe(_)});let l=n.syncPointTree_.get(i);l?(o=o||fe(l),r=r||he(l,w())):(l=new Xt,n.syncPointTree_=n.syncPointTree_.set(i,l));let a;r!=null?a=!0:(a=!1,r=m.EMPTY_NODE,n.syncPointTree_.subtree(i).foreachChild((_,p)=>{let T=he(p,w());T&&(r=r.updateImmediateChild(_,T))}));let c=Wo(l,e);if(!c&&!e._queryParams.loadsAllData()){let d=_n(e);f(!n.queryToTagMap.has(d),"View does not exist, but we have a tag");let _=Lc();n.queryToTagMap.set(d,_),n.tagToQueryMap.set(_,d)}let h=un(n.pendingWriteTree_,i),u=Tc(l,e,t,h,r,a);if(!c&&!o&&!s){let d=Fo(l,e);u=u.concat(Fc(n,e,d))}return u}function fn(n,e,t){let i=n.pendingWriteTree_,r=n.syncPointTree_.findOnPath(e,(o,l)=>{let a=L(o,e),c=he(l,a);if(c)return c});return Po(i,e,r,t,!0)}function Dc(n,e){let t=e._path,s=null;n.syncPointTree_.foreachOnPath(t,(c,h)=>{let u=L(c,t);s=s||he(h,u)});let i=n.syncPointTree_.get(t);i?s=s||he(i,w()):(i=new Xt,n.syncPointTree_=n.syncPointTree_.set(t,i));let r=s!=null,o=r?new ne(s,!0,!1):null,l=un(n.pendingWriteTree_,e._path),a=Mo(i,e,l,r?o.getNode():m.EMPTY_NODE,r);return gc(a)}function je(n,e){return Bo(e,n.syncPointTree_,null,un(n.pendingWriteTree_,w()))}function Bo(n,e,t,s){if(v(n.path))return Vo(n,e,t,s);{let i=e.get(w());t==null&&i!=null&&(t=he(i,w()));let r=[],o=y(n.path),l=n.operationForChild(o),a=e.children.get(o);if(a&&l){let c=t?t.getImmediateChild(o):null,h=ko(s,o);r=r.concat(Bo(l,a,c,h))}return i&&(r=r.concat(ri(i,n,s,t))),r}}function Vo(n,e,t,s){let i=e.get(w());t==null&&i!=null&&(t=he(i,w()));let r=[];return e.children.inorderTraversal((o,l)=>{let a=t?t.getImmediateChild(o):null,c=ko(s,o),h=n.operationForChild(o);h&&(r=r.concat(Vo(h,l,a,c)))}),i&&(r=r.concat(ri(i,n,s,t))),r}function Go(n,e){let t=e.query,s=_t(n,t);return{hashFn:()=>(pc(e)||m.EMPTY_NODE).hash(),onComplete:i=>{if(i==="ok")return s?Ac(n,t._path,s):kc(n,t._path);{let r=ql(i,t);return en(n,t,null,r)}}}}function _t(n,e){let t=_n(e);return n.queryToTagMap.get(t)}function _n(n){return n._path.toString()+"$"+n._queryIdentifier}function li(n,e){return n.tagToQueryMap.get(e)}function ai(n){let e=n.indexOf("$");return f(e!==-1&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new E(n.substr(0,e))}}function ci(n,e,t){let s=n.syncPointTree_.get(e);f(s,"Missing sync point for query tag that we're tracking");let i=un(n.pendingWriteTree_,e);return ri(s,t,i,null)}function Oc(n){return n.fold((e,t,s)=>{if(t&&fe(t))return[dn(t)];{let i=[];return t&&(i=Lo(t)),x(s,(r,o)=>{i=i.concat(o)}),i}})}function it(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(bc())(n._repo,n._path):n}function Mc(n,e){for(let t=0;t<e.length;++t){let s=e[t];if(!s._queryParams.loadsAllData()){let i=_n(s),r=n.queryToTagMap.get(i);n.queryToTagMap.delete(i),n.tagToQueryMap.delete(r)}}}function Lc(){return Nc++}function Fc(n,e,t){let s=e._path,i=_t(n,e),r=Go(n,t),o=n.listenProvider_.startListening(it(e),i,r.hashFn,r.onComplete),l=n.syncPointTree_.subtree(s);if(i)f(!fe(l.value),"If we're adding a query, it shouldn't be shadowed");else{let a=l.fold((c,h,u)=>{if(!v(c)&&h&&fe(h))return[dn(h).query];{let d=[];return h&&(d=d.concat(Lo(h).map(_=>_.query))),x(u,(_,p)=>{d=d.concat(p)}),d}});for(let c=0;c<a.length;++c){let h=a[c];n.listenProvider_.stopListening(it(h),_t(n,h))}}return o}var bs=class n{constructor(e){this.node_=e}getImmediateChild(e){let t=this.node_.getImmediateChild(e);return new n(t)}node(){return this.node_}},Ns=class n{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){let t=b(this.path_,e);return new n(this.syncTree_,t)}node(){return fn(this.syncTree_,this.path_)}},Wc=function(n){return n=n||{},n.timestamp=n.timestamp||new Date().getTime(),n},jr=function(n,e,t){if(!n||typeof n!="object")return n;if(f(".sv"in n,"Unexpected leaf node or priority contents"),typeof n[".sv"]=="string")return Uc(n[".sv"],e,t);if(typeof n[".sv"]=="object")return Bc(n[".sv"],e);f(!1,"Unexpected server value: "+JSON.stringify(n,null,2))},Uc=function(n,e,t){switch(n){case"timestamp":return t.timestamp;default:f(!1,"Unexpected server value: "+n)}},Bc=function(n,e,t){n.hasOwnProperty("increment")||f(!1,"Unexpected server value: "+JSON.stringify(n,null,2));let s=n.increment;typeof s!="number"&&f(!1,"Unexpected increment value: "+s);let i=e.node();if(f(i!==null&&typeof i<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return s;let o=i.getValue();return typeof o!="number"?s:o+s},Ho=function(n,e,t,s){return ui(e,new Ns(t,n),s)},hi=function(n,e,t){return ui(n,new bs(e),t)};function ui(n,e,t){let s=n.getPriority().val(),i=jr(s,e.getImmediateChild(".priority"),t),r;if(n.isLeafNode()){let o=n,l=jr(o.getValue(),e,t);return l!==o.getValue()||i!==o.getPriority().val()?new Le(l,N(i)):n}else{let o=n;return r=o,i!==o.getPriority().val()&&(r=r.updatePriority(new Le(i))),o.forEachChild(S,(l,a)=>{let c=ui(a,e.getImmediateChild(l),t);c!==a&&(r=r.updateImmediateChild(l,c))}),r}}var pt=class{constructor(e="",t=null,s={children:{},childCount:0}){this.name=e,this.parent=t,this.node=s}};function pn(n,e){let t=e instanceof E?e:new E(e),s=n,i=y(t);for(;i!==null;){let r=le(s.node.children,i)||{children:{},childCount:0};s=new pt(i,s,r),t=I(t),i=y(t)}return s}function Se(n){return n.node.value}function di(n,e){n.node.value=e,Rs(n)}function Qo(n){return n.node.childCount>0}function Vc(n){return Se(n)===void 0&&!Qo(n)}function gn(n,e){x(n.node.children,(t,s)=>{e(new pt(t,n,s))})}function jo(n,e,t,s){t&&!s&&e(n),gn(n,i=>{jo(i,e,!0,s)}),t&&s&&e(n)}function Gc(n,e,t){let s=t?n:n.parent;for(;s!==null;){if(e(s))return!0;s=s.parent}return!1}function Tt(n){return new E(n.parent===null?n.name:Tt(n.parent)+"/"+n.name)}function Rs(n){n.parent!==null&&Hc(n.parent,n.name,n)}function Hc(n,e,t){let s=Vc(t),i=j(n.node.children,e);s&&i?(delete n.node.children[e],n.node.childCount--,Rs(n)):!s&&!i&&(n.node.children[e]=t.node,n.node.childCount++,Rs(n))}var Qc=/[\[\].#$\/\u0000-\u001F\u007F]/,jc=/[\[\].#$\u0000-\u001F\u007F]/,Un=10*1024*1024,mn=function(n){return typeof n=="string"&&n.length!==0&&!Qc.test(n)},Ko=function(n){return typeof n=="string"&&n.length!==0&&!jc.test(n)},Kc=function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),Ko(n)},gt=function(n){return n===null||typeof n=="string"||typeof n=="number"&&!an(n)||n&&typeof n=="object"&&j(n,".sv")},se=function(n,e,t,s){s&&e===void 0||It(U(n,"value"),e,t)},It=function(n,e,t){let s=t instanceof E?new Jn(t,n):t;if(e===void 0)throw new Error(n+"contains undefined "+ve(s));if(typeof e=="function")throw new Error(n+"contains a function "+ve(s)+" with contents = "+e.toString());if(an(e))throw new Error(n+"contains "+e.toString()+" "+ve(s));if(typeof e=="string"&&e.length>Un/3&&ze(e)>Un)throw new Error(n+"contains a string greater than "+Un+" utf8 bytes "+ve(s)+" ('"+e.substring(0,50)+"...')");if(e&&typeof e=="object"){let i=!1,r=!1;if(x(e,(o,l)=>{if(o===".value")i=!0;else if(o!==".priority"&&o!==".sv"&&(r=!0,!mn(o)))throw new Error(n+" contains an invalid key ("+o+") "+ve(s)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);Ea(s,o),It(n,l,s),Ta(s)}),i&&r)throw new Error(n+' contains ".value" child '+ve(s)+" in addition to actual children.")}},qc=function(n,e){let t,s;for(t=0;t<e.length;t++){s=e[t];let r=ot(s);for(let o=0;o<r.length;o++)if(!(r[o]===".priority"&&o===r.length-1)){if(!mn(r[o]))throw new Error(n+"contains an invalid key ("+r[o]+") in path "+s.toString()+`. Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`)}}e.sort(wa);let i=null;for(t=0;t<e.length;t++){if(s=e[t],i!==null&&K(i,s))throw new Error(n+"contains a path "+i.toString()+" that is ancestor of another path "+s.toString());i=s}},qo=function(n,e,t,s){if(s&&e===void 0)return;let i=U(n,"values");if(!(e&&typeof e=="object")||Array.isArray(e))throw new Error(i+" must be an object containing the children to replace.");let r=[];x(e,(o,l)=>{let a=new E(o);if(It(i,l,b(t,a)),zs(a)===".priority"&&!gt(l))throw new Error(i+"contains an invalid value for '"+a.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");r.push(a)}),qc(i,r)},fi=function(n,e,t){if(!(t&&e===void 0)){if(an(e))throw new Error(U(n,"priority")+"is "+e.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!gt(e))throw new Error(U(n,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")}},St=function(n,e,t,s){if(!(s&&t===void 0)&&!mn(t))throw new Error(U(n,e)+'was an invalid key = "'+t+`".  Firebase keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]").`)},Ke=function(n,e,t,s){if(!(s&&t===void 0)&&!Ko(t))throw new Error(U(n,e)+'was an invalid path = "'+t+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},Yc=function(n,e,t,s){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),Ke(n,e,t,s)},V=function(n,e){if(y(e)===".info")throw new Error(n+" failed = Can't modify data under /.info/")},Yo=function(n,e){let t=e.path.toString();if(typeof e.repoInfo.host!="string"||e.repoInfo.host.length===0||!mn(e.repoInfo.namespace)&&e.repoInfo.host.split(":")[0]!=="localhost"||t.length!==0&&!Kc(t))throw new Error(U(n,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};var Ps=class{constructor(){this.eventLists_=[],this.recursionDepth_=0}};function yn(n,e){let t=null;for(let s=0;s<e.length;s++){let i=e[s],r=i.getPath();t!==null&&!$s(r,t.path)&&(n.eventLists_.push(t),t=null),t===null&&(t={events:[],path:r}),t.events.push(i)}t&&n.eventLists_.push(t)}function zo(n,e,t){yn(n,t),$o(n,s=>$s(s,e))}function G(n,e,t){yn(n,t),$o(n,s=>K(s,e)||K(e,s))}function $o(n,e){n.recursionDepth_++;let t=!0;for(let s=0;s<n.eventLists_.length;s++){let i=n.eventLists_[s];if(i){let r=i.path;e(r)?(zc(n.eventLists_[s]),n.eventLists_[s]=null):t=!1}}t&&(n.eventLists_=[]),n.recursionDepth_--}function zc(n){for(let e=0;e<n.events.length;e++){let t=n.events[e];if(t!==null){n.events[e]=null;let s=t.getEventRunner();we&&A("event: "+t.toString()),He(s)}}}var Xo="repo_interrupt",$c=25,ks=class{constructor(e,t,s,i){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=s,this.appCheckProvider_=i,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new Ps,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=Qt(),this.transactionQueueTree_=new pt,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}};function Xc(n,e,t){if(n.stats_=Ys(n.repoInfo_),n.forceRestClient_||Xl())n.server_=new cs(n.repoInfo_,(s,i,r,o)=>{Kr(n,s,i,r,o)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>qr(n,!0),0);else{if(typeof t<"u"&&t!==null){if(typeof t!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{R(t)}catch(s){throw new Error("Invalid authOverride provided: "+s)}}n.persistentConnection_=new Xs(n.repoInfo_,e,(s,i,r,o)=>{Kr(n,s,i,r,o)},s=>{qr(n,s)},s=>{Jc(n,s)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(s=>{n.server_.refreshAuthToken(s)}),n.appCheckProvider_.addTokenChangeListener(s=>{n.server_.refreshAppCheckToken(s.token)}),n.statsReporter_=Zl(n.repoInfo_,()=>new _s(n.stats_,n.server_)),n.infoData_=new hs,n.infoSyncTree_=new Zt({startListening:(s,i,r,o)=>{let l=[],a=n.infoData_.getNode(s._path);return a.isEmpty()||(l=Et(n.infoSyncTree_,s._path,a),setTimeout(()=>{o("ok")},0)),l},stopListening:()=>{}}),_i(n,"connected",!1),n.serverSyncTree_=new Zt({startListening:(s,i,r,o)=>(n.server_.listen(s,r,i,(l,a)=>{let c=o(l,a);G(n.eventQueue_,s._path,c)}),[]),stopListening:(s,i)=>{n.server_.unlisten(s,i)}})}function Jo(n){let t=n.infoData_.getNode(new E(".info/serverTimeOffset")).val()||0;return new Date().getTime()+t}function bt(n){return Wc({timestamp:Jo(n)})}function Kr(n,e,t,s,i){n.dataUpdateCount++;let r=new E(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let o=[];if(i)if(s){let a=Ye(t,c=>N(c));o=xc(n.serverSyncTree_,r,a,i)}else{let a=N(t);o=Uo(n.serverSyncTree_,r,a,i)}else if(s){let a=Ye(t,c=>N(c));o=Pc(n.serverSyncTree_,r,a)}else{let a=N(t);o=Et(n.serverSyncTree_,r,a)}let l=r;o.length>0&&(l=Ve(n,r)),G(n.eventQueue_,l,o)}function qr(n,e){_i(n,"connected",e),e===!1&&th(n)}function Jc(n,e){x(e,(t,s)=>{_i(n,t,s)})}function _i(n,e,t){let s=new E("/.info/"+e),i=N(t);n.infoData_.updateSnapshot(s,i);let r=Et(n.infoSyncTree_,s,i);G(n.eventQueue_,s,r)}function vn(n){return n.nextWriteId_++}function Zc(n,e,t){let s=Dc(n.serverSyncTree_,e);return s!=null?Promise.resolve(s):n.server_.get(e).then(i=>{let r=N(i).withIndex(e._queryParams.getIndex());Ss(n.serverSyncTree_,e,t,!0);let o;if(e._queryParams.loadsAllData())o=Et(n.serverSyncTree_,e._path,r);else{let l=_t(n.serverSyncTree_,e);o=Uo(n.serverSyncTree_,e._path,r,l)}return G(n.eventQueue_,e._path,o),en(n.serverSyncTree_,e,t,null,!0),r},i=>(qe(n,"get for query "+R(e)+" failed: "+i),Promise.reject(new Error(i))))}function pi(n,e,t,s,i){qe(n,"set",{path:e.toString(),value:t,priority:s});let r=bt(n),o=N(t,s),l=fn(n.serverSyncTree_,e),a=hi(o,l,r),c=vn(n),h=oi(n.serverSyncTree_,e,a,c,!0);yn(n.eventQueue_,h),n.server_.put(e.toString(),o.val(!0),(d,_)=>{let p=d==="ok";p||O("set at "+e+" failed: "+d);let T=ae(n.serverSyncTree_,c,!p);G(n.eventQueue_,e,T),_e(n,i,d,_)});let u=mi(n,e);Ve(n,u),G(n.eventQueue_,u,[])}function eh(n,e,t,s){qe(n,"update",{path:e.toString(),value:t});let i=!0,r=bt(n),o={};if(x(t,(l,a)=>{i=!1,o[l]=Ho(b(e,l),N(a),n.serverSyncTree_,r)}),i)A("update() called with empty data.  Don't do anything."),_e(n,s,"ok",void 0);else{let l=vn(n),a=Rc(n.serverSyncTree_,e,o,l);yn(n.eventQueue_,a),n.server_.merge(e.toString(),t,(c,h)=>{let u=c==="ok";u||O("update at "+e+" failed: "+c);let d=ae(n.serverSyncTree_,l,!u),_=d.length>0?Ve(n,e):e;G(n.eventQueue_,_,d),_e(n,s,c,h)}),x(t,c=>{let h=mi(n,b(e,c));Ve(n,h)}),G(n.eventQueue_,e,[])}}function th(n){qe(n,"onDisconnectEvents");let e=bt(n),t=Qt();ds(n.onDisconnect_,w(),(i,r)=>{let o=Ho(i,r,n.serverSyncTree_,e);Qe(t,i,o)});let s=[];ds(t,w(),(i,r)=>{s=s.concat(Et(n.serverSyncTree_,i,r));let o=mi(n,i);Ve(n,o)}),n.onDisconnect_=Qt(),G(n.eventQueue_,w(),s)}function nh(n,e,t){n.server_.onDisconnectCancel(e.toString(),(s,i)=>{s==="ok"&&us(n.onDisconnect_,e),_e(n,t,s,i)})}function Yr(n,e,t,s){let i=N(t);n.server_.onDisconnectPut(e.toString(),i.val(!0),(r,o)=>{r==="ok"&&Qe(n.onDisconnect_,e,i),_e(n,s,r,o)})}function sh(n,e,t,s,i){let r=N(t,s);n.server_.onDisconnectPut(e.toString(),r.val(!0),(o,l)=>{o==="ok"&&Qe(n.onDisconnect_,e,r),_e(n,i,o,l)})}function ih(n,e,t,s){if(kt(t)){A("onDisconnect().update() called with empty data.  Don't do anything."),_e(n,s,"ok",void 0);return}n.server_.onDisconnectMerge(e.toString(),t,(i,r)=>{i==="ok"&&x(t,(o,l)=>{let a=N(l);Qe(n.onDisconnect_,b(e,o),a)}),_e(n,s,i,r)})}function rh(n,e,t){let s;y(e._path)===".info"?s=Ss(n.infoSyncTree_,e,t):s=Ss(n.serverSyncTree_,e,t),zo(n.eventQueue_,e._path,s)}function As(n,e,t){let s;y(e._path)===".info"?s=en(n.infoSyncTree_,e,t):s=en(n.serverSyncTree_,e,t),zo(n.eventQueue_,e._path,s)}function Zo(n){n.persistentConnection_&&n.persistentConnection_.interrupt(Xo)}function oh(n){n.persistentConnection_&&n.persistentConnection_.resume(Xo)}function qe(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),A(t,...e)}function _e(n,e,t,s){e&&He(()=>{if(t==="ok")e(null);else{let i=(t||"error").toUpperCase(),r=i;s&&(r+=": "+s);let o=new Error(r);o.code=i,e(o)}})}function lh(n,e,t,s,i,r){qe(n,"transaction on "+e);let o={path:e,update:t,onComplete:s,status:null,order:Xr(),applyLocally:r,retryCount:0,unwatcher:i,abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},l=gi(n,e,void 0);o.currentInputSnapshot=l;let a=o.update(l.val());if(a===void 0)o.unwatcher(),o.currentOutputSnapshotRaw=null,o.currentOutputSnapshotResolved=null,o.onComplete&&o.onComplete(null,!1,o.currentInputSnapshot);else{It("transaction failed: Data returned ",a,o.path),o.status=0;let c=pn(n.transactionQueueTree_,e),h=Se(c)||[];h.push(o),di(c,h);let u;typeof a=="object"&&a!==null&&j(a,".priority")?(u=le(a,".priority"),f(gt(u),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):u=(fn(n.serverSyncTree_,e)||m.EMPTY_NODE).getPriority().val();let d=bt(n),_=N(a,u),p=hi(_,l,d);o.currentOutputSnapshotRaw=_,o.currentOutputSnapshotResolved=p,o.currentWriteId=vn(n);let T=oi(n.serverSyncTree_,e,p,o.currentWriteId,o.applyLocally);G(n.eventQueue_,e,T),Cn(n,n.transactionQueueTree_)}}function gi(n,e,t){return fn(n.serverSyncTree_,e,t)||m.EMPTY_NODE}function Cn(n,e=n.transactionQueueTree_){if(e||wn(n,e),Se(e)){let t=tl(n,e);f(t.length>0,"Sending zero length transaction queue"),t.every(i=>i.status===0)&&ah(n,Tt(e),t)}else Qo(e)&&gn(e,t=>{Cn(n,t)})}function ah(n,e,t){let s=t.map(c=>c.currentWriteId),i=gi(n,e,s),r=i,o=i.hash();for(let c=0;c<t.length;c++){let h=t[c];f(h.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),h.status=1,h.retryCount++;let u=L(e,h.path);r=r.updateChild(u,h.currentOutputSnapshotRaw)}let l=r.val(!0),a=e;n.server_.put(a.toString(),l,c=>{qe(n,"transaction put response",{path:a.toString(),status:c});let h=[];if(c==="ok"){let u=[];for(let d=0;d<t.length;d++)t[d].status=2,h=h.concat(ae(n.serverSyncTree_,t[d].currentWriteId)),t[d].onComplete&&u.push(()=>t[d].onComplete(null,!0,t[d].currentOutputSnapshotResolved)),t[d].unwatcher();wn(n,pn(n.transactionQueueTree_,e)),Cn(n,n.transactionQueueTree_),G(n.eventQueue_,e,h);for(let d=0;d<u.length;d++)He(u[d])}else{if(c==="datastale")for(let u=0;u<t.length;u++)t[u].status===3?t[u].status=4:t[u].status=0;else{O("transaction at "+a.toString()+" failed: "+c);for(let u=0;u<t.length;u++)t[u].status=4,t[u].abortReason=c}Ve(n,e)}},o)}function Ve(n,e){let t=el(n,e),s=Tt(t),i=tl(n,t);return ch(n,i,s),s}function ch(n,e,t){if(e.length===0)return;let s=[],i=[],o=e.filter(l=>l.status===0).map(l=>l.currentWriteId);for(let l=0;l<e.length;l++){let a=e[l],c=L(t,a.path),h=!1,u;if(f(c!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),a.status===4)h=!0,u=a.abortReason,i=i.concat(ae(n.serverSyncTree_,a.currentWriteId,!0));else if(a.status===0)if(a.retryCount>=$c)h=!0,u="maxretry",i=i.concat(ae(n.serverSyncTree_,a.currentWriteId,!0));else{let d=gi(n,a.path,o);a.currentInputSnapshot=d;let _=e[l].update(d.val());if(_!==void 0){It("transaction failed: Data returned ",_,a.path);let p=N(_);typeof _=="object"&&_!=null&&j(_,".priority")||(p=p.updatePriority(d.getPriority()));let k=a.currentWriteId,X=bt(n),ie=hi(p,d,X);a.currentOutputSnapshotRaw=p,a.currentOutputSnapshotResolved=ie,a.currentWriteId=vn(n),o.splice(o.indexOf(k),1),i=i.concat(oi(n.serverSyncTree_,a.path,ie,a.currentWriteId,a.applyLocally)),i=i.concat(ae(n.serverSyncTree_,k,!0))}else h=!0,u="nodata",i=i.concat(ae(n.serverSyncTree_,a.currentWriteId,!0))}G(n.eventQueue_,t,i),i=[],h&&(e[l].status=2,function(d){setTimeout(d,Math.floor(0))}(e[l].unwatcher),e[l].onComplete&&(u==="nodata"?s.push(()=>e[l].onComplete(null,!1,e[l].currentInputSnapshot)):s.push(()=>e[l].onComplete(new Error(u),!1,null))))}wn(n,n.transactionQueueTree_);for(let l=0;l<s.length;l++)He(s[l]);Cn(n,n.transactionQueueTree_)}function el(n,e){let t,s=n.transactionQueueTree_;for(t=y(e);t!==null&&Se(s)===void 0;)s=pn(s,t),e=I(e),t=y(e);return s}function tl(n,e){let t=[];return nl(n,e,t),t.sort((s,i)=>s.order-i.order),t}function nl(n,e,t){let s=Se(e);if(s)for(let i=0;i<s.length;i++)t.push(s[i]);gn(e,i=>{nl(n,i,t)})}function wn(n,e){let t=Se(e);if(t){let s=0;for(let i=0;i<t.length;i++)t[i].status!==2&&(t[s]=t[i],s++);t.length=s,di(e,t.length>0?t:void 0)}gn(e,s=>{wn(n,s)})}function mi(n,e){let t=Tt(el(n,e)),s=pn(n.transactionQueueTree_,e);return Gc(s,i=>{Bn(n,i)}),Bn(n,s),jo(s,i=>{Bn(n,i)}),t}function Bn(n,e){let t=Se(e);if(t){let s=[],i=[],r=-1;for(let o=0;o<t.length;o++)t[o].status===3||(t[o].status===1?(f(r===o-1,"All SENT items should be at beginning of queue."),r=o,t[o].status=3,t[o].abortReason="set"):(f(t[o].status===0,"Unexpected transaction status in abort"),t[o].unwatcher(),i=i.concat(ae(n.serverSyncTree_,t[o].currentWriteId,!0)),t[o].onComplete&&s.push(t[o].onComplete.bind(null,new Error("set"),!1,null))));r===-1?di(e,void 0):t.length=r+1,G(n.eventQueue_,Tt(e),i);for(let o=0;o<s.length;o++)He(s[o])}}function hh(n){let e="",t=n.split("/");for(let s=0;s<t.length;s++)if(t[s].length>0){let i=t[s];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch{}e+="/"+i}return e}function uh(n){let e={};n.charAt(0)==="?"&&(n=n.substring(1));for(let t of n.split("&")){if(t.length===0)continue;let s=t.split("=");s.length===2?e[decodeURIComponent(s[0])]=decodeURIComponent(s[1]):O(`Invalid query segment '${t}' in query '${n}'`)}return e}var xs=function(n,e){let t=dh(n),s=t.namespace;t.domain==="firebase.com"&&te(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!s||s==="undefined")&&t.domain!=="localhost"&&te("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||Gl();let i=t.scheme==="ws"||t.scheme==="wss";return{repoInfo:new Lt(t.host,t.secure,s,i,e,"",s!==t.subdomain),path:new E(t.pathString)}},dh=function(n){let e="",t="",s="",i="",r="",o=!0,l="https",a=443;if(typeof n=="string"){let c=n.indexOf("//");c>=0&&(l=n.substring(0,c-1),n=n.substring(c+2));let h=n.indexOf("/");h===-1&&(h=n.length);let u=n.indexOf("?");u===-1&&(u=n.length),e=n.substring(0,Math.min(h,u)),h<u&&(i=hh(n.substring(h,u)));let d=uh(n.substring(Math.min(n.length,u)));c=e.indexOf(":"),c>=0?(o=l==="https"||l==="wss",a=parseInt(e.substring(c+1),10)):c=e.length;let _=e.slice(0,c);if(_.toLowerCase()==="localhost")t="localhost";else if(_.split(".").length<=2)t=_;else{let p=e.indexOf(".");s=e.substring(0,p).toLowerCase(),t=e.substring(p+1),r=s}"ns"in d&&(r=d.ns)}return{host:e,port:a,domain:t,subdomain:s,secure:o,scheme:l,pathString:i,namespace:r}};var zr="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",fh=function(){let n=0,e=[];return function(t){let s=t===n;n=t;let i,r=new Array(8);for(i=7;i>=0;i--)r[i]=zr.charAt(t%64),t=Math.floor(t/64);f(t===0,"Cannot push at time == 0");let o=r.join("");if(s){for(i=11;i>=0&&e[i]===63;i--)e[i]=0;e[i]++}else for(i=0;i<12;i++)e[i]=Math.floor(Math.random()*64);for(i=0;i<12;i++)o+=zr.charAt(e[i]);return f(o.length===20,"nextPushId: Length should be 20."),o}}();var tn=class{constructor(e,t,s,i){this.eventType=e,this.eventRegistration=t,this.snapshot=s,this.prevName=i}getPath(){let e=this.snapshot.ref;return this.eventType==="value"?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+R(this.snapshot.exportVal())}},nn=class{constructor(e,t,s){this.eventRegistration=e,this.error=t,this.path=s}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}};var mt=class{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return f(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}};var sn=class{constructor(e,t){this._repo=e,this._path=t}cancel(){let e=new M;return nh(this._repo,this._path,e.wrapCallback(()=>{})),e.promise}remove(){V("OnDisconnect.remove",this._path);let e=new M;return Yr(this._repo,this._path,null,e.wrapCallback(()=>{})),e.promise}set(e){V("OnDisconnect.set",this._path),se("OnDisconnect.set",e,this._path,!1);let t=new M;return Yr(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}setWithPriority(e,t){V("OnDisconnect.setWithPriority",this._path),se("OnDisconnect.setWithPriority",e,this._path,!1),fi("OnDisconnect.setWithPriority",t,!1);let s=new M;return sh(this._repo,this._path,e,t,s.wrapCallback(()=>{})),s.promise}update(e){V("OnDisconnect.update",this._path),qo("OnDisconnect.update",e,this._path,!1);let t=new M;return ih(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}};var W=class n{constructor(e,t,s,i){this._repo=e,this._path=t,this._queryParams=s,this._orderByCalled=i}get key(){return v(this._path)?null:zs(this._path)}get ref(){return new H(this._repo,this._path)}get _queryIdentifier(){let e=Mr(this._queryParams),t=qs(e);return t==="{}"?"default":t}get _queryObject(){return Mr(this._queryParams)}isEqual(e){if(e=B(e),!(e instanceof n))return!1;let t=this._repo===e._repo,s=$s(this._path,e._path),i=this._queryIdentifier===e._queryIdentifier;return t&&s&&i}toJSON(){return this.toString()}toString(){return this._repo.toString()+Ca(this._path)}};function En(n,e){if(n._orderByCalled===!0)throw new Error(e+": You can't combine multiple orderBy calls.")}function ge(n){let e=null,t=null;if(n.hasStart()&&(e=n.getIndexStartValue()),n.hasEnd()&&(t=n.getIndexEndValue()),n.getIndex()===ee){let s="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",i="Query: When ordering by key, the argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() must be a string.";if(n.hasStart()){if(n.getIndexStartName()!==ue)throw new Error(s);if(typeof e!="string")throw new Error(i)}if(n.hasEnd()){if(n.getIndexEndName()!==re)throw new Error(s);if(typeof t!="string")throw new Error(i)}}else if(n.getIndex()===S){if(e!=null&&!gt(e)||t!=null&&!gt(t))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), startAfter() endAt(), endBefore(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if(f(n.getIndex()instanceof lt||n.getIndex()===Zs,"unknown index type."),e!=null&&typeof e=="object"||t!=null&&typeof t=="object")throw new Error("Query: First argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() cannot be an object.")}function Tn(n){if(n.hasStart()&&n.hasEnd()&&n.hasLimit()&&!n.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), startAfter(), endAt(), endBefore(), and limit(). Use limitToFirst() or limitToLast() instead.")}var H=class n extends W{constructor(e,t){super(e,t,new ut,!1)}get parent(){let e=vo(this._path);return e===null?null:new n(this._repo,e)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}},Ge=class n{constructor(e,t,s){this._node=e,this.ref=t,this._index=s}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){let t=new E(e),s=pe(this.ref,e);return new n(this._node.getChild(t),s,S)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(s,i)=>e(new n(i,pe(this.ref,s),S)))}hasChild(e){let t=new E(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}};function yi(n,e){return n=B(n),n._checkNotDeleted("ref"),e!==void 0?pe(n._root,e):n._root}function vi(n,e){n=B(n),n._checkNotDeleted("refFromURL");let t=xs(e,n._repo.repoInfo_.nodeAdmin);Yo("refFromURL",t);let s=t.repoInfo;return!n._repo.repoInfo_.isCustomHost()&&s.host!==n._repo.repoInfo_.host&&te("refFromURL: Host name does not match the current database: (found "+s.host+" but expected "+n._repo.repoInfo_.host+")"),yi(n,t.path.toString())}function pe(n,e){return n=B(n),y(n._path)===null?Yc("child","path",e,!1):Ke("child","path",e,!1),new H(n._repo,b(n._path,e))}function sl(n,e){n=B(n),V("push",n._path),se("push",e,n._path,!0);let t=Jo(n._repo),s=fh(t),i=pe(n,s),r=pe(n,s),o;return e!=null?o=In(r,e).then(()=>r):o=Promise.resolve(r),i.then=o.then.bind(o),i.catch=o.then.bind(o,void 0),i}function il(n){return V("remove",n._path),In(n,null)}function In(n,e){n=B(n),V("set",n._path),se("set",e,n._path,!1);let t=new M;return pi(n._repo,n._path,e,null,t.wrapCallback(()=>{})),t.promise}function rl(n,e){n=B(n),V("setPriority",n._path),fi("setPriority",e,!1);let t=new M;return pi(n._repo,b(n._path,".priority"),e,null,t.wrapCallback(()=>{})),t.promise}function ol(n,e,t){if(V("setWithPriority",n._path),se("setWithPriority",e,n._path,!1),fi("setWithPriority",t,!1),n.key===".length"||n.key===".keys")throw"setWithPriority failed: "+n.key+" is a read-only object.";let s=new M;return pi(n._repo,n._path,e,t,s.wrapCallback(()=>{})),s.promise}function ll(n,e){qo("update",e,n._path,!1);let t=new M;return eh(n._repo,n._path,e,t.wrapCallback(()=>{})),t.promise}function al(n){n=B(n);let e=new mt(()=>{}),t=new yt(e);return Zc(n._repo,n,t).then(s=>new Ge(s,new H(n._repo,n._path),n._queryParams.getIndex()))}var yt=class n{constructor(e){this.callbackContext=e}respondsTo(e){return e==="value"}createEvent(e,t){let s=t._queryParams.getIndex();return new tn("value",this,new Ge(e.snapshotNode,new H(t._repo,t._path),s))}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new nn(this,e,t):null}matches(e){return e instanceof n?!e.callbackContext||!this.callbackContext?!0:e.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}},rn=class n{constructor(e,t){this.eventType=e,this.callbackContext=t}respondsTo(e){let t=e==="children_added"?"child_added":e;return t=t==="children_removed"?"child_removed":t,this.eventType===t}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new nn(this,e,t):null}createEvent(e,t){f(e.childName!=null,"Child events should have a childName.");let s=pe(new H(t._repo,t._path),e.childName),i=t._queryParams.getIndex();return new tn(e.type,this,new Ge(e.snapshotNode,s,i),e.prevName)}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,e.prevName)}matches(e){return e instanceof n?this.eventType===e.eventType&&(!this.callbackContext||!e.callbackContext||this.callbackContext.matches(e.callbackContext)):!1}hasAnyCallback(){return!!this.callbackContext}};function Nt(n,e,t,s,i){let r;if(typeof s=="object"&&(r=void 0,i=s),typeof s=="function"&&(r=s),i&&i.onlyOnce){let a=t,c=(h,u)=>{As(n._repo,n,l),a(h,u)};c.userCallback=t.userCallback,c.context=t.context,t=c}let o=new mt(t,r||void 0),l=e==="value"?new yt(o):new rn(e,o);return rh(n._repo,n,l),()=>As(n._repo,n,l)}function Sn(n,e,t,s){return Nt(n,"value",e,t,s)}function Ci(n,e,t,s){return Nt(n,"child_added",e,t,s)}function wi(n,e,t,s){return Nt(n,"child_changed",e,t,s)}function Ei(n,e,t,s){return Nt(n,"child_moved",e,t,s)}function Ti(n,e,t,s){return Nt(n,"child_removed",e,t,s)}function Ii(n,e,t){let s=null,i=t?new mt(t):null;e==="value"?s=new yt(i):e&&(s=new rn(e,i)),As(n._repo,n,s)}var Q=class{},on=class extends Q{constructor(e,t){super(),this._value=e,this._key=t,this.type="endAt"}_apply(e){se("endAt",this._value,e._path,!0);let t=as(e._queryParams,this._value,this._key);if(Tn(t),ge(t),e._queryParams.hasEnd())throw new Error("endAt: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new W(e._repo,e._path,t,e._orderByCalled)}};function cl(n,e){return St("endAt","key",e,!0),new on(n,e)}var Ds=class extends Q{constructor(e,t){super(),this._value=e,this._key=t,this.type="endBefore"}_apply(e){se("endBefore",this._value,e._path,!1);let t=Ua(e._queryParams,this._value,this._key);if(Tn(t),ge(t),e._queryParams.hasEnd())throw new Error("endBefore: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new W(e._repo,e._path,t,e._orderByCalled)}};function hl(n,e){return St("endBefore","key",e,!0),new Ds(n,e)}var ln=class extends Q{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAt"}_apply(e){se("startAt",this._value,e._path,!0);let t=ls(e._queryParams,this._value,this._key);if(Tn(t),ge(t),e._queryParams.hasStart())throw new Error("startAt: Starting point was already set (by another call to startAt, startBefore or equalTo).");return new W(e._repo,e._path,t,e._orderByCalled)}};function ul(n=null,e){return St("startAt","key",e,!0),new ln(n,e)}var Os=class extends Q{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAfter"}_apply(e){se("startAfter",this._value,e._path,!1);let t=Wa(e._queryParams,this._value,this._key);if(Tn(t),ge(t),e._queryParams.hasStart())throw new Error("startAfter: Starting point was already set (by another call to startAt, startAfter, or equalTo).");return new W(e._repo,e._path,t,e._orderByCalled)}};function dl(n,e){return St("startAfter","key",e,!0),new Os(n,e)}var Ms=class extends Q{constructor(e){super(),this._limit=e,this.type="limitToFirst"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToFirst: Limit was already set (by another call to limitToFirst or limitToLast).");return new W(e._repo,e._path,La(e._queryParams,this._limit),e._orderByCalled)}};function fl(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToFirst: First argument must be a positive integer.");return new Ms(n)}var Ls=class extends Q{constructor(e){super(),this._limit=e,this.type="limitToLast"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToLast: Limit was already set (by another call to limitToFirst or limitToLast).");return new W(e._repo,e._path,Fa(e._queryParams,this._limit),e._orderByCalled)}};function _l(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToLast: First argument must be a positive integer.");return new Ls(n)}var Fs=class extends Q{constructor(e){super(),this._path=e,this.type="orderByChild"}_apply(e){En(e,"orderByChild");let t=new E(this._path);if(v(t))throw new Error("orderByChild: cannot pass in empty path. Use orderByValue() instead.");let s=new lt(t),i=cn(e._queryParams,s);return ge(i),new W(e._repo,e._path,i,!0)}};function pl(n){if(n==="$key")throw new Error('orderByChild: "$key" is invalid.  Use orderByKey() instead.');if(n==="$priority")throw new Error('orderByChild: "$priority" is invalid.  Use orderByPriority() instead.');if(n==="$value")throw new Error('orderByChild: "$value" is invalid.  Use orderByValue() instead.');return Ke("orderByChild","path",n,!1),new Fs(n)}var Ws=class extends Q{constructor(){super(...arguments),this.type="orderByKey"}_apply(e){En(e,"orderByKey");let t=cn(e._queryParams,ee);return ge(t),new W(e._repo,e._path,t,!0)}};function gl(){return new Ws}var Us=class extends Q{constructor(){super(...arguments),this.type="orderByPriority"}_apply(e){En(e,"orderByPriority");let t=cn(e._queryParams,S);return ge(t),new W(e._repo,e._path,t,!0)}};function ml(){return new Us}var Bs=class extends Q{constructor(){super(...arguments),this.type="orderByValue"}_apply(e){En(e,"orderByValue");let t=cn(e._queryParams,Zs);return ge(t),new W(e._repo,e._path,t,!0)}};function yl(){return new Bs}var Vs=class extends Q{constructor(e,t){super(),this._value=e,this._key=t,this.type="equalTo"}_apply(e){if(se("equalTo",this._value,e._path,!1),e._queryParams.hasStart())throw new Error("equalTo: Starting point was already set (by another call to startAt/startAfter or equalTo).");if(e._queryParams.hasEnd())throw new Error("equalTo: Ending point was already set (by another call to endAt/endBefore or equalTo).");return new on(this._value,this._key)._apply(new ln(this._value,this._key)._apply(e))}};function vl(n,e){return St("equalTo","key",e,!0),new Vs(n,e)}function Y(n,...e){let t=B(n);for(let s of e)t=s._apply(t);return t}Cc(H);Sc(H);var _h="FIREBASE_DATABASE_EMULATOR_HOST",Gs={},ph=!1;function gh(n,e,t,s){n.repoInfo_=new Lt(`${e}:${t}`,!1,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0),s&&(n.authTokenProvider_=s)}function Si(n,e,t,s,i){let r=s||n.options.databaseURL;r===void 0&&(n.options.projectId||te("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),A("Using default host for project ",n.options.projectId),r=`${n.options.projectId}-default-rtdb.firebaseio.com`);let o=xs(r,i),l=o.repoInfo,a,c;typeof process<"u"&&process.env&&(c=process.env[_h]),c?(a=!0,r=`http://${c}?ns=${l.namespace}`,o=xs(r,i),l=o.repoInfo):a=!o.repoInfo.secure;let h=i&&a?new tt(tt.OWNER):new Kn(n.name,n.options,e);Yo("Invalid Firebase Database URL",o),v(o.path)||te("Database URL must point to the root of a Firebase Database (not including a child path).");let u=yh(l,n,h,new jn(n.name,t));return new Hs(u,n)}function mh(n,e){let t=Gs[e];(!t||t[n.key]!==n)&&te(`Database ${e}(${n.repoInfo_}) has already been deleted.`),Zo(n),delete t[n.key]}function yh(n,e,t,s){let i=Gs[e.name];i||(i={},Gs[e.name]=i);let r=i[n.toURLString()];return r&&te("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),r=new ks(n,ph,t,s),i[n.toURLString()]=r,r}var Hs=class{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(Xc(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new H(this._repo,w())),this._rootInternal}_delete(){return this._rootInternal!==null&&(mh(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&te("Cannot call "+e+" on a deleted database.")}};function Cl(){yo.IS_TRANSPORT_INITIALIZED&&O("Transport has already been initialized. Please call this function before calling ref or setting up a listener")}function wl(){Cl(),rt.forceDisallow()}function El(){Cl(),xe.forceDisallow(),rt.forceAllow()}function Tl(n,e,t,s={}){n=B(n),n._checkNotDeleted("useEmulator"),n._instanceStarted&&te("Cannot call useEmulator() after instance has already been initialized.");let i=n._repoInternal,r;if(i.repoInfo_.nodeAdmin)s.mockUserToken&&te('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),r=new tt(tt.OWNER);else if(s.mockUserToken){let o=typeof s.mockUserToken=="string"?s.mockUserToken:qi(s.mockUserToken,n.app.options.projectId);r=new tt(o)}gh(i,e,t,r)}function Il(n){n=B(n),n._checkNotDeleted("goOffline"),Zo(n._repo)}function Sl(n){n=B(n),n._checkNotDeleted("goOnline"),oh(n._repo)}function bl(n,e){Zr(n,e)}function vh(n){Ks(nr),tr(new ke("database",(e,{instanceIdentifier:t})=>{let s=e.getProvider("app").getImmediate(),i=e.getProvider("auth-internal"),r=e.getProvider("app-check-internal");return Si(s,i,r,t)},"PUBLIC").setMultipleInstances(!0)),Dn(yr,vr,n),Dn(yr,vr,"esm2017")}var Ch={".sv":"timestamp"};function Nl(){return Ch}function Rl(n){return{".sv":{increment:n}}}var Qs=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return{committed:this.committed,snapshot:this.snapshot.toJSON()}}};function Pl(n,e,t){var s;if(n=B(n),V("Reference.transaction",n._path),n.key===".length"||n.key===".keys")throw"Reference.transaction failed: "+n.key+" is a read-only object.";let i=(s=t?.applyLocally)!==null&&s!==void 0?s:!0,r=new M,o=(a,c,h)=>{let u=null;a?r.reject(a):(u=new Ge(h,new H(n._repo,n._path),S),r.resolve(new Qs(c,u)))},l=Sn(n,()=>{});return lh(n._repo,n._path,e,o,l,i),r.promise}Xs.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)};Xs.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)};vh();var wh="@firebase/database-compat",Eh="1.0.4";var Th=new xt("@firebase/database-compat"),kl=function(n){let e="FIREBASE WARNING: "+n;Th.warn(e)};var Ih=function(n,e,t,s){if(!(s&&t===void 0)&&typeof t!="boolean")throw new Error(U(n,e)+"must be a boolean.")},Sh=function(n,e,t){if(!(t&&e===void 0))switch(e){case"value":case"child_added":case"child_removed":case"child_changed":case"child_moved":break;default:throw new Error(U(n,"eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}};var bi=class{constructor(e){this._delegate=e}cancel(e){g("OnDisconnect.cancel",0,1,arguments.length),P("OnDisconnect.cancel","onComplete",e,!0);let t=this._delegate.cancel();return e&&t.then(()=>e(null),s=>e(s)),t}remove(e){g("OnDisconnect.remove",0,1,arguments.length),P("OnDisconnect.remove","onComplete",e,!0);let t=this._delegate.remove();return e&&t.then(()=>e(null),s=>e(s)),t}set(e,t){g("OnDisconnect.set",1,2,arguments.length),P("OnDisconnect.set","onComplete",t,!0);let s=this._delegate.set(e);return t&&s.then(()=>t(null),i=>t(i)),s}setWithPriority(e,t,s){g("OnDisconnect.setWithPriority",2,3,arguments.length),P("OnDisconnect.setWithPriority","onComplete",s,!0);let i=this._delegate.setWithPriority(e,t);return s&&i.then(()=>s(null),r=>s(r)),i}update(e,t){if(g("OnDisconnect.update",1,2,arguments.length),Array.isArray(e)){let i={};for(let r=0;r<e.length;++r)i[""+r]=e[r];e=i,kl("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}P("OnDisconnect.update","onComplete",t,!0);let s=this._delegate.update(e);return t&&s.then(()=>t(null),i=>t(i)),s}};var Ni=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return g("TransactionResult.toJSON",0,1,arguments.length),{committed:this.committed,snapshot:this.snapshot.toJSON()}}};var be=class n{constructor(e,t){this._database=e,this._delegate=t}val(){return g("DataSnapshot.val",0,0,arguments.length),this._delegate.val()}exportVal(){return g("DataSnapshot.exportVal",0,0,arguments.length),this._delegate.exportVal()}toJSON(){return g("DataSnapshot.toJSON",0,1,arguments.length),this._delegate.toJSON()}exists(){return g("DataSnapshot.exists",0,0,arguments.length),this._delegate.exists()}child(e){return g("DataSnapshot.child",0,1,arguments.length),e=String(e),Ke("DataSnapshot.child","path",e,!1),new n(this._database,this._delegate.child(e))}hasChild(e){return g("DataSnapshot.hasChild",1,1,arguments.length),Ke("DataSnapshot.hasChild","path",e,!1),this._delegate.hasChild(e)}getPriority(){return g("DataSnapshot.getPriority",0,0,arguments.length),this._delegate.priority}forEach(e){return g("DataSnapshot.forEach",1,1,arguments.length),P("DataSnapshot.forEach","action",e,!1),this._delegate.forEach(t=>e(new n(this._database,t)))}hasChildren(){return g("DataSnapshot.hasChildren",0,0,arguments.length),this._delegate.hasChildren()}get key(){return this._delegate.key}numChildren(){return g("DataSnapshot.numChildren",0,0,arguments.length),this._delegate.size}getRef(){return g("DataSnapshot.ref",0,0,arguments.length),new oe(this._database,this._delegate.ref)}get ref(){return this.getRef()}},bn=class n{constructor(e,t){this.database=e,this._delegate=t}on(e,t,s,i){var r;g("Query.on",2,4,arguments.length),P("Query.on","callback",t,!1);let o=n.getCancelAndContextArgs_("Query.on",s,i),l=(c,h)=>{t.call(o.context,new be(this.database,c),h)};l.userCallback=t,l.context=o.context;let a=(r=o.cancel)===null||r===void 0?void 0:r.bind(o.context);switch(e){case"value":return Sn(this._delegate,l,a),t;case"child_added":return Ci(this._delegate,l,a),t;case"child_removed":return Ti(this._delegate,l,a),t;case"child_changed":return wi(this._delegate,l,a),t;case"child_moved":return Ei(this._delegate,l,a),t;default:throw new Error(U("Query.on","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}}off(e,t,s){if(g("Query.off",0,3,arguments.length),Sh("Query.off",e,!0),P("Query.off","callback",t,!0),An("Query.off","context",s,!0),t){let i=()=>{};i.userCallback=t,i.context=s,Ii(this._delegate,e,i)}else Ii(this._delegate,e)}get(){return al(this._delegate).then(e=>new be(this.database,e))}once(e,t,s,i){g("Query.once",1,4,arguments.length),P("Query.once","callback",t,!0);let r=n.getCancelAndContextArgs_("Query.once",s,i),o=new M,l=(c,h)=>{let u=new be(this.database,c);t&&t.call(r.context,u,h),o.resolve(u)};l.userCallback=t,l.context=r.context;let a=c=>{r.cancel&&r.cancel.call(r.context,c),o.reject(c)};switch(e){case"value":Sn(this._delegate,l,a,{onlyOnce:!0});break;case"child_added":Ci(this._delegate,l,a,{onlyOnce:!0});break;case"child_removed":Ti(this._delegate,l,a,{onlyOnce:!0});break;case"child_changed":wi(this._delegate,l,a,{onlyOnce:!0});break;case"child_moved":Ei(this._delegate,l,a,{onlyOnce:!0});break;default:throw new Error(U("Query.once","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}return o.promise}limitToFirst(e){return g("Query.limitToFirst",1,1,arguments.length),new n(this.database,Y(this._delegate,fl(e)))}limitToLast(e){return g("Query.limitToLast",1,1,arguments.length),new n(this.database,Y(this._delegate,_l(e)))}orderByChild(e){return g("Query.orderByChild",1,1,arguments.length),new n(this.database,Y(this._delegate,pl(e)))}orderByKey(){return g("Query.orderByKey",0,0,arguments.length),new n(this.database,Y(this._delegate,gl()))}orderByPriority(){return g("Query.orderByPriority",0,0,arguments.length),new n(this.database,Y(this._delegate,ml()))}orderByValue(){return g("Query.orderByValue",0,0,arguments.length),new n(this.database,Y(this._delegate,yl()))}startAt(e=null,t){return g("Query.startAt",0,2,arguments.length),new n(this.database,Y(this._delegate,ul(e,t)))}startAfter(e=null,t){return g("Query.startAfter",0,2,arguments.length),new n(this.database,Y(this._delegate,dl(e,t)))}endAt(e=null,t){return g("Query.endAt",0,2,arguments.length),new n(this.database,Y(this._delegate,cl(e,t)))}endBefore(e=null,t){return g("Query.endBefore",0,2,arguments.length),new n(this.database,Y(this._delegate,hl(e,t)))}equalTo(e,t){return g("Query.equalTo",1,2,arguments.length),new n(this.database,Y(this._delegate,vl(e,t)))}toString(){return g("Query.toString",0,0,arguments.length),this._delegate.toString()}toJSON(){return g("Query.toJSON",0,1,arguments.length),this._delegate.toJSON()}isEqual(e){if(g("Query.isEqual",1,1,arguments.length),!(e instanceof n)){let t="Query.isEqual failed: First argument must be an instance of firebase.database.Query.";throw new Error(t)}return this._delegate.isEqual(e._delegate)}static getCancelAndContextArgs_(e,t,s){let i={cancel:void 0,context:void 0};if(t&&s)i.cancel=t,P(e,"cancel",i.cancel,!0),i.context=s,An(e,"context",i.context,!0);else if(t)if(typeof t=="object"&&t!==null)i.context=t;else if(typeof t=="function")i.cancel=t;else throw new Error(U(e,"cancelOrContext")+" must either be a cancel callback or a context object.");return i}get ref(){return new oe(this.database,new H(this._delegate._repo,this._delegate._path))}},oe=class n extends bn{constructor(e,t){super(e,new W(t._repo,t._path,new ut,!1)),this.database=e,this._delegate=t}getKey(){return g("Reference.key",0,0,arguments.length),this._delegate.key}child(e){return g("Reference.child",1,1,arguments.length),typeof e=="number"&&(e=String(e)),new n(this.database,pe(this._delegate,e))}getParent(){g("Reference.parent",0,0,arguments.length);let e=this._delegate.parent;return e?new n(this.database,e):null}getRoot(){return g("Reference.root",0,0,arguments.length),new n(this.database,this._delegate.root)}set(e,t){g("Reference.set",1,2,arguments.length),P("Reference.set","onComplete",t,!0);let s=In(this._delegate,e);return t&&s.then(()=>t(null),i=>t(i)),s}update(e,t){if(g("Reference.update",1,2,arguments.length),Array.isArray(e)){let i={};for(let r=0;r<e.length;++r)i[""+r]=e[r];e=i,kl("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}V("Reference.update",this._delegate._path),P("Reference.update","onComplete",t,!0);let s=ll(this._delegate,e);return t&&s.then(()=>t(null),i=>t(i)),s}setWithPriority(e,t,s){g("Reference.setWithPriority",2,3,arguments.length),P("Reference.setWithPriority","onComplete",s,!0);let i=ol(this._delegate,e,t);return s&&i.then(()=>s(null),r=>s(r)),i}remove(e){g("Reference.remove",0,1,arguments.length),P("Reference.remove","onComplete",e,!0);let t=il(this._delegate);return e&&t.then(()=>e(null),s=>e(s)),t}transaction(e,t,s){g("Reference.transaction",1,3,arguments.length),P("Reference.transaction","transactionUpdate",e,!1),P("Reference.transaction","onComplete",t,!0),Ih("Reference.transaction","applyLocally",s,!0);let i=Pl(this._delegate,e,{applyLocally:s}).then(r=>new Ni(r.committed,new be(this.database,r.snapshot)));return t&&i.then(r=>t(null,r.committed,r.snapshot),r=>t(r,!1,null)),i}setPriority(e,t){g("Reference.setPriority",1,2,arguments.length),P("Reference.setPriority","onComplete",t,!0);let s=rl(this._delegate,e);return t&&s.then(()=>t(null),i=>t(i)),s}push(e,t){g("Reference.push",0,2,arguments.length),P("Reference.push","onComplete",t,!0);let s=sl(this._delegate,e),i=s.then(o=>new n(this.database,o));t&&i.then(()=>t(null),o=>t(o));let r=new n(this.database,s);return r.then=i.then.bind(i),r.catch=i.catch.bind(i,void 0),r}onDisconnect(){return V("Reference.onDisconnect",this._delegate._path),new bi(new sn(this._delegate._repo,this._delegate._path))}get key(){return this.getKey()}get parent(){return this.getParent()}get root(){return this.getRoot()}};var Ne=class{constructor(e,t){this._delegate=e,this.app=t,this.INTERNAL={delete:()=>this._delegate._delete(),forceWebSockets:wl,forceLongPolling:El}}useEmulator(e,t,s={}){Tl(this._delegate,e,t,s)}ref(e){if(g("database.ref",0,1,arguments.length),e instanceof oe){let t=vi(this._delegate,e.toString());return new oe(this,t)}else{let t=yi(this._delegate,e);return new oe(this,t)}}refFromURL(e){g("database.refFromURL",1,1,arguments.length);let s=vi(this._delegate,e);return new oe(this,s)}goOffline(){return g("database.goOffline",0,0,arguments.length),Il(this._delegate)}goOnline(){return g("database.goOnline",0,0,arguments.length),Sl(this._delegate)}};Ne.ServerValue={TIMESTAMP:Nl(),increment:n=>Rl(n)};function bh({app:n,url:e,version:t,customAuthImpl:s,customAppCheckImpl:i,namespace:r,nodeAdmin:o=!1}){Ks(t);let l=new xn("database-standalone"),a=new At("auth-internal",l);a.setComponent(new ke("auth-internal",()=>s,"PRIVATE"));let c;return i&&(c=new At("app-check-internal",l),c.setComponent(new ke("app-check-internal",()=>i,"PRIVATE"))),{instance:new Ne(Si(n,a,c,e,o),n),namespace:r}}var Nh=Object.freeze({__proto__:null,initStandalone:bh});var Rh=Ne.ServerValue;function Ph(n){n.INTERNAL.registerComponent(new ke("database-compat",(e,{instanceIdentifier:t})=>{let s=e.getProvider("app-compat").getImmediate(),i=e.getProvider("database").getImmediate({identifier:t});return new Ne(i,s)},"PUBLIC").setServiceProps({Reference:oe,Query:bn,Database:Ne,DataSnapshot:be,enableLogging:bl,INTERNAL:Nh,ServerValue:Rh}).setMultipleInstances(!0)),n.registerVersion(wh,Eh)}Ph(Dt);function Rt(n,e,t="on",s=xi){return new Ai(i=>{let r=null;return r=n[t](e,(o,l)=>{s.schedule(()=>{i.next({snapshot:o,prevKey:l})}),t==="once"&&s.schedule(()=>i.complete())},o=>{s.schedule(()=>i.error(o))}),t==="on"?{unsubscribe(){r!=null&&n.off(e,r)}}:{unsubscribe(){}}}).pipe(me(i=>{let{snapshot:r,prevKey:o}=i,l=null;return r.exists()&&(l=r.key),{type:e,payload:r,prevKey:o,key:l}}),Mi())}function kh(n){return typeof n=="string"}function Ah(n){return typeof n.exportVal=="function"}function Ml(n){return n==null}function Ll(n){return typeof n.set=="function"}function Al(n,e){return Ll(e)?e:n.ref(e)}function Fl(n,e){if(kh(n))return e.stringCase();if(Ll(n))return e.firebaseCase();if(Ah(n))return e.snapshotCase();throw new Error(`Expects a string, snapshot, or reference. Got: ${typeof n}`)}function Wl(n){return(Ml(n)||n.length===0)&&(n=["child_added","child_removed","child_changed","child_moved"]),n}function Ul(n,e,t){e=Wl(e);let s=e.map(i=>Rt(n,i,"on",t));return Nn(...s)}function xh(n,e,t){let s=Ul(n,e).pipe(Rn((i,r)=>[...i,r],[]));return Oh(n,s,t)}function Dh(n,e){return Rt(n,"value","on",e).pipe(me(t=>{let s;return t.payload.forEach(i=>(s=i.key,!1)),{data:t,lastKeyToLoad:s}}))}function Oh(n,e,t){return Dh(n,t).pipe(Wi(e),me(([i,r])=>{let o=i.lastKeyToLoad,l=r.map(a=>a.key);return{actions:r,lastKeyToLoad:o,loadedKeys:l}}),Li(i=>i.loadedKeys.indexOf(i.lastKeyToLoad)===-1),me(i=>i.actions))}function xl(n,e){return function(s,i){return Fl(s,{stringCase:()=>n.child(s)[e](i),firebaseCase:()=>s[e](i),snapshotCase:()=>s.ref[e](i)})}}function Mh(n){return function(t){return t?Fl(t,{stringCase:()=>n.child(t).remove(),firebaseCase:()=>t.remove(),snapshotCase:()=>t.ref.remove()}):n.remove()}}function Lh(n,e,t){return Rt(n,"value","once",t).pipe(Fi(s=>{let i=[Di(s)];return e.forEach(r=>i.push(Rt(n,r,"on",t))),Nn(...i).pipe(Rn(Wh,[]))}),Oi())}function Bl(n,e){let t=n.length;for(let s=0;s<t;s++)if(n[s].payload.key===e)return s;return-1}function Fh(n,e){if(Ml(e))return 0;{let t=Bl(n,e);return t===-1?n.length:t+1}}function Wh(n,e){let{payload:t,prevKey:s,key:i}=e,r=Bl(n,i),o=Fh(n,s);switch(e.type){case"value":if(e.payload?.exists()){let l=null;e.payload.forEach(a=>{let c={payload:a,type:"value",prevKey:l,key:a.key};return l=a.key,n=[...n,c],!1})}return n;case"child_added":if(r>-1)(n[r-1]?.key||null)!==s&&(n=n.filter(a=>a.payload.key!==t.key),n.splice(o,0,e));else{if(s==null)return[e,...n];n=n.slice(),n.splice(o,0,e)}return n;case"child_removed":return n.filter(l=>l.payload.key!==t.key);case"child_changed":return n.map(l=>l.payload.key===i?e:l);case"child_moved":if(r>-1){let l=n.splice(r,1)[0];return n=n.slice(),n.splice(o,0,l),n}return n;default:return n}}function Dl(n,e,t){return e=Wl(e),Lh(n,e,t)}function Uh(n,e){let t=e.schedulers.outsideAngular,s=e.schedulers.ngZone.run(()=>n.ref);return{query:n,update:xl(s,"update"),set:xl(s,"set"),push:i=>s.push(i),remove:Mh(s),snapshotChanges(i){return Dl(n,i,t).pipe(ye)},stateChanges(i){return Ul(n,i,t).pipe(ye)},auditTrail(i){return xh(n,i,t).pipe(ye)},valueChanges(i,r){return Dl(n,i,t).pipe(me(l=>l.map(a=>r&&r.idField?Pi(Ri({},a.payload.val()),{[r.idField]:a.key}):a.payload.val())),ye)}}}function Ol(n,e){return function(){return Rt(n,"value","on",e)}}function Bh(n,e){return{query:n,snapshotChanges(){return Ol(n,e.schedulers.outsideAngular)().pipe(ye)},update(t){return n.ref.update(t)},set(t){return n.ref.set(t)},remove(){return n.ref.remove()},valueChanges(){return Ol(n,e.schedulers.outsideAngular)().pipe(ye,me(s=>s.payload.exists()?s.payload.val():null))}}}var Vh=new Pn("angularfire2.realtimeDatabaseURL"),Gh=new Pn("angularfire2.database.use-emulator"),Hh=(()=>{class n{schedulers;database;constructor(t,s,i,r,o,l,a,c,h,u,d,_,p,T,k){this.schedulers=l;let X=a,ie=ar(t,o,s);c&&gr(ie,o,h,d,_,p,u,T),this.database=cr(`${ie.name}.database.${i}`,"AngularFireDatabase",ie.name,()=>{let Re=o.runOutsideAngular(()=>ie.database(i||void 0));return X&&Re.useEmulator(...X),Re},[X])}list(t,s){let i=this.schedulers.ngZone.runOutsideAngular(()=>Al(this.database,t)),r=i;return s&&(r=s(i)),Uh(r,this)}object(t){let s=this.schedulers.ngZone.runOutsideAngular(()=>Al(this.database,t));return Bh(s,this)}createPushId(){return this.schedulers.ngZone.runOutsideAngular(()=>this.database.ref()).push().key}static \u0275fac=function(s){return new(s||n)(D(or),D(lr,8),D(Vh,8),D(Gi),D(Hi),D(rr),D(Gh,8),D(mr,8),D(hr,8),D(ur,8),D(dr,8),D(fr,8),D(_r,8),D(pr,8),D(ir,8))};static \u0275prov=Ui({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})(),Tu=(()=>{class n{constructor(){Dt.registerVersion("angularfire",sr.full,"rtdb-compat")}static \u0275fac=function(s){return new(s||n)};static \u0275mod=Vi({type:n});static \u0275inj=Bi({providers:[Hh]})}return n})();export{Hh as a,Tu as b};
